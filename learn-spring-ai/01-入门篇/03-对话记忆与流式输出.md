# ç¬¬3æœŸï¼šå¯¹è¯è®°å¿†ä¸æµå¼è¾“å‡º - æ‰“é€ æ›´æ™ºèƒ½çš„äº¤äº’ä½“éªŒ

## ğŸ“Œ æœ¬æœŸæ¦‚è¿°

**æ ¸å¿ƒé—®é¢˜ï¼šå¦‚ä½•å®ç°å¤šè½®å¯¹è¯è®°å¿†å’Œå®æ—¶æµå¼å“åº”ï¼Ÿ**

å•è½®å¯¹è¯å¾€å¾€æ— æ³•æ»¡è¶³å¤æ‚çš„äº¤äº’éœ€æ±‚ã€‚æœ¬æœŸå°†æ·±å…¥è®²è§£Spring AIçš„ChatMemoryæœºåˆ¶ï¼Œä»¥åŠå¦‚ä½•å®ç°æµå¼è¾“å‡ºï¼Œæ‰“é€ ç±»ä¼¼ChatGPTçš„ç”¨æˆ·ä½“éªŒã€‚

## ğŸ¯ å­¦ä¹ ç›®æ ‡

å®Œæˆæœ¬æœŸå­¦ä¹ åï¼Œä½ å°†èƒ½å¤Ÿï¼š
- âœ… ç†è§£ChatMemoryçš„å·¥ä½œåŸç†
- âœ… å®ç°ä¸Šä¸‹æ–‡æ„ŸçŸ¥çš„å¤šè½®å¯¹è¯
- âœ… æŒæ¡SSEæµå¼è¾“å‡ºæŠ€æœ¯
- âœ… å®ç°å‰ç«¯å®æ—¶æ¸²æŸ“æµå¼å“åº”
- âœ… ä¼˜åŒ–ä¼šè¯ç®¡ç†å’Œå†…å­˜ä½¿ç”¨

## ğŸ“š å†…å®¹å¤§çº²

### 1. ä¸ºä»€ä¹ˆéœ€è¦å¯¹è¯è®°å¿†ï¼Ÿ

### 2. Spring AIçš„ChatMemoryæœºåˆ¶

### 3. å®ç°å¤šè½®å¯¹è¯

### 4. æµå¼è¾“å‡ºï¼ˆSSEï¼‰åŸç†

### 5. å‰ç«¯å®æ—¶æ¸²æŸ“å®ç°

### 6. ä¼šè¯ç®¡ç†ä¸ä¼˜åŒ–

---

## 1. ä¸ºä»€ä¹ˆéœ€è¦å¯¹è¯è®°å¿†ï¼Ÿ

### 1.1 å•è½®å¯¹è¯çš„å±€é™æ€§

åœ¨å‰ä¸¤æœŸä¸­ï¼Œæˆ‘ä»¬å®ç°çš„éƒ½æ˜¯**æ— çŠ¶æ€çš„å•è½®å¯¹è¯**ï¼š

```java
// æ¯æ¬¡è°ƒç”¨éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œæ²¡æœ‰ä¸Šä¸‹æ–‡
String response = chatModel.call("ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ");
// AIå›ç­”å¤©æ°”...

String response2 = chatModel.call("é‚£æ˜å¤©å‘¢ï¼Ÿ");
// AIä¸çŸ¥é“ä½ åœ¨é—®ä»€ä¹ˆï¼Œå› ä¸ºå¿˜è®°äº†ä¸Šä¸€è½®å¯¹è¯ï¼
```

**é—®é¢˜æ¼”ç¤º**ï¼š

| å¯¹è¯è½®æ¬¡ | ç”¨æˆ·è¾“å…¥ | AIå›å¤ï¼ˆæ— è®°å¿†ï¼‰ | AIå›å¤ï¼ˆæœ‰è®°å¿†ï¼‰ |
|---------|---------|----------------|----------------|
| ç¬¬1è½® | "æˆ‘å«å¼ ä¸‰" | "ä½ å¥½ï¼" | "ä½ å¥½ï¼Œå¼ ä¸‰ï¼" |
| ç¬¬2è½® | "æˆ‘å«ä»€ä¹ˆåå­—ï¼Ÿ" | "æˆ‘ä¸çŸ¥é“ä½ çš„åå­—" | "ä½ å«å¼ ä¸‰" |
| ç¬¬3è½® | "æ¨èä¸€æœ¬ä¹¦" | "ã€Šä¸‰ä½“ã€‹" | "å¼ ä¸‰ï¼Œæˆ‘æ¨èã€Šä¸‰ä½“ã€‹" |

### 1.2 å®é™…åº”ç”¨åœºæ™¯

**åœºæ™¯1ï¼šå®¢æœå¯¹è¯**
```
ç”¨æˆ·ï¼šæˆ‘çš„è®¢å•å·æ˜¯12345
å®¢æœAIï¼šå¥½çš„ï¼Œæˆ‘æŸ¥è¯¢ä¸€ä¸‹
ç”¨æˆ·ï¼šè®¢å•çŠ¶æ€å¦‚ä½•ï¼Ÿ
å®¢æœAIï¼šâŒ "è¯·æä¾›è®¢å•å·"ï¼ˆå¿˜è®°äº†ï¼ï¼‰
      âœ… "è®¢å•12345å·²å‘è´§"ï¼ˆè®°å¾—è®¢å•å·ï¼‰
```

**åœºæ™¯2ï¼šä»£ç åŠ©æ‰‹**
```
ç”¨æˆ·ï¼šå¸®æˆ‘å†™ä¸€ä¸ªæ’åºå‡½æ•°
AIï¼šç”Ÿæˆäº†å†’æ³¡æ’åºä»£ç 
ç”¨æˆ·ï¼šæ”¹æˆå¿«é€Ÿæ’åº
AIï¼šâŒ "ä»€ä¹ˆæ”¹æˆå¿«é€Ÿæ’åºï¼Ÿ"
   âœ… ç›´æ¥ä¿®æ”¹åˆšæ‰çš„æ’åºå‡½æ•°
```

**åœºæ™¯3ï¼šçŸ¥è¯†é—®ç­”**
```
ç”¨æˆ·ï¼šä»€ä¹ˆæ˜¯Spring AIï¼Ÿ
AIï¼šSpring AIæ˜¯ä¸€ä¸ªAIåº”ç”¨å¼€å‘æ¡†æ¶...
ç”¨æˆ·ï¼šå®ƒæœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼Ÿ
AIï¼šâŒ "ä»€ä¹ˆæœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼Ÿ"
   âœ… "Spring AIçš„ä¼˜åŠ¿æ˜¯..."
```

### 1.3 ChatGPTæ˜¯å¦‚ä½•åšçš„ï¼Ÿ

ChatGPTçš„æ¯æ¬¡å¯¹è¯éƒ½ä¼šæºå¸¦**å®Œæ•´çš„å†å²è®°å½•**ï¼š

```json
{
  "messages": [
    {"role": "user", "content": "æˆ‘å«å¼ ä¸‰"},
    {"role": "assistant", "content": "ä½ å¥½ï¼Œå¼ ä¸‰ï¼"},
    {"role": "user", "content": "æˆ‘å«ä»€ä¹ˆåå­—ï¼Ÿ"},
    {"role": "assistant", "content": "ä½ å«å¼ ä¸‰"}
  ]
}
```

è¿™æ ·AIå°±èƒ½"è®°ä½"ä¹‹å‰è¯´è¿‡çš„è¯ï¼

---

## 2. Spring AIçš„ChatMemoryæœºåˆ¶

Spring AIæä¾›äº†å¼ºå¤§çš„å¯¹è¯è®°å¿†ç®¡ç†æœºåˆ¶ã€‚

### 2.1 æ ¸å¿ƒç»„ä»¶

**ChatMemoryæ¥å£**ï¼š
```java
public interface ChatMemory {
    // æ·»åŠ æ¶ˆæ¯åˆ°ä¼šè¯
    void add(String conversationId, Message message);
    
    // è·å–ä¼šè¯çš„æ‰€æœ‰æ¶ˆæ¯
    List<Message> get(String conversationId, int lastN);
    
    // æ¸…ç©ºä¼šè¯
    void clear(String conversationId);
}
```

**å†…ç½®å®ç°**ï¼š

| å®ç°ç±» | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|-------|------|---------|
| `InMemoryChatMemory` | å†…å­˜å­˜å‚¨ï¼Œç®€å•å¿«é€Ÿ | å•æœºã€æµ‹è¯•ç¯å¢ƒ |
| `MessageWindowChatMemory` | æ»‘åŠ¨çª—å£ï¼Œåªä¿ç•™æœ€è¿‘Næ¡ | é•¿å¯¹è¯ï¼Œæ§åˆ¶æˆæœ¬ |
| `RedisChatMemory` | Rediså­˜å‚¨ï¼Œæ”¯æŒåˆ†å¸ƒå¼ | ç”Ÿäº§ç¯å¢ƒã€å¤šå®ä¾‹ |

### 2.2 MessageChatMemoryAdvisor

Spring AIä½¿ç”¨**Advisoræ¨¡å¼**è‡ªåŠ¨ç®¡ç†å¯¹è¯è®°å¿†ï¼š

```java
ChatClient chatClient = ChatClient.builder(chatModel)
    .defaultAdvisors(
        // â­ è‡ªåŠ¨æ·»åŠ å†å²æ¶ˆæ¯åˆ°æ¯æ¬¡è¯·æ±‚
        MessageChatMemoryAdvisor.builder(chatMemory).build()
    )
    .build();
```

**å·¥ä½œæµç¨‹**ï¼š

```
ç”¨æˆ·è¾“å…¥ï¼š"æˆ‘å«ä»€ä¹ˆåå­—ï¼Ÿ"
    â†“
Advisoræ‹¦æˆªè¯·æ±‚
    â†“
ä»ChatMemoryåŠ è½½å†å²ï¼š
  - "æˆ‘å«å¼ ä¸‰"
  - "ä½ å¥½ï¼Œå¼ ä¸‰ï¼"
    â†“
ç»„åˆæˆå®Œæ•´Promptï¼š
  [å†å²æ¶ˆæ¯] + [å½“å‰è¾“å…¥]
    â†“
è°ƒç”¨AIæ¨¡å‹
    â†“
è¿”å›ï¼š"ä½ å«å¼ ä¸‰"
    â†“
Advisorä¿å­˜å›å¤åˆ°ChatMemory
```

### 2.3 ä¼šè¯IDçš„é‡è¦æ€§

æ¯ä¸ªå¯¹è¯éƒ½éœ€è¦ä¸€ä¸ªå”¯ä¸€çš„**conversationId**ï¼š

```java
// âŒ é”™è¯¯ï¼šæ‰€æœ‰ç”¨æˆ·å…±äº«ä¸€ä¸ªä¼šè¯
chatMemory.add("global", message);

// âœ… æ­£ç¡®ï¼šæ¯ä¸ªç”¨æˆ·ç‹¬ç«‹ä¼šè¯
chatMemory.add(userId, message);

// âœ… æ›´å¥½ï¼šæ”¯æŒå¤šä¼šè¯
chatMemory.add(userId + "-conversation1", message);
chatMemory.add(userId + "-conversation2", message);
```

---

## 3. å®ç°å¤šè½®å¯¹è¯

ç°åœ¨æˆ‘ä»¬æ¥å®ç°ä¸€ä¸ªå®Œæ•´çš„å¤šè½®å¯¹è¯ç³»ç»Ÿï¼

é¡¹ç›®ä»£ç ï¼š[https://github.com/Mark7766/spring-ai-apps/tree/main/memory-llama](https://github.com/Mark7766/spring-ai-apps/tree/main/memory-llama)

### 3.1 é¡¹ç›®ä¾èµ–é…ç½®

```xml
<!-- æ¥è‡ªï¼šhttps://github.com/Mark7766/spring-ai-apps/blob/main/memory-llama/pom.xml -->
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0">
    <modelVersion>4.0.0</modelVersion>
    
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.5.4</version>
    </parent>
    
    <groupId>com.sandy</groupId>
    <artifactId>memory-llama</artifactId>
    <version>0.0.2-SNAPSHOT</version>
    
    <properties>
        <java.version>17</java.version>
        <spring-ai.version>1.0.0</spring-ai.version>
    </properties>
    
    <dependencies>
        <!-- Spring Boot Web -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        
        <!-- â­ Spring AI Ollama Starterï¼ˆæœ¬åœ°æ¨¡å‹ï¼‰ -->
        <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-starter-model-ollama</artifactId>
        </dependency>
        
        <!-- Lombokï¼ˆç®€åŒ–ä»£ç ï¼‰ -->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>
    </dependencies>
    
    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.springframework.ai</groupId>
                <artifactId>spring-ai-bom</artifactId>
                <version>${spring-ai.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>
</project>
```

**å…³é”®å·®å¼‚**ï¼š
- ä½¿ç”¨`spring-ai-starter-model-ollama`æœ¬åœ°æ¨¡å‹ï¼ˆå…è´¹ã€éšç§ï¼‰
- æ— éœ€APIå¯†é’¥ï¼Œé€‚åˆå­¦ä¹ å’Œæµ‹è¯•

### 3.2 åº”ç”¨é…ç½®

```yaml
# æ¥è‡ªï¼šhttps://github.com/Mark7766/spring-ai-apps/blob/main/memory-llama/src/main/resources/application.yml
server:
  port: 8081

spring:
  application:
    name: "memory-llama"
  
  ai:
    ollama:
      # OllamaæœåŠ¡åœ°å€ï¼ˆéœ€å…ˆå¯åŠ¨Ollamaï¼‰
      base-url: "http://localhost:11434"
      
      # Embeddingé…ç½®
      embedding:
        enabled: true
        model: qwen2.5
      
      # Chaté…ç½®
      chat:
        enabled: true
        model: qwen2.5  # ä½¿ç”¨é€šä¹‰åƒé—®2.5æ¨¡å‹
```

**Ollamaå®‰è£…æç¤º**ï¼š
```bash
# Windows/Macï¼šä¸‹è½½å®‰è£…åŒ…
# https://ollama.ai/download

# å®‰è£…åæ‹‰å–æ¨¡å‹
ollama pull qwen2.5

# éªŒè¯
ollama list
```

### 3.3 ChatMessageå®ä½“ç±»

å®šä¹‰æ¶ˆæ¯æ•°æ®ç»“æ„ï¼š

```java
// æ¥è‡ªï¼šhttps://github.com/Mark7766/spring-ai-apps/blob/main/memory-llama/src/main/java/com/sandy/memory/ollama/ChatMessage.java
package com.sandy.memory.ollama;

import lombok.Data;

@Data
public class ChatMessage {
    private String role;      // "user" æˆ– "assistant"
    private String content;   // æ¶ˆæ¯å†…å®¹
    private Long timestamp;   // æ—¶é—´æˆ³
}
```

ç®€æ´æ˜äº†ï¼ŒLombokè‡ªåŠ¨ç”Ÿæˆgetter/setterã€‚

### 3.4 ChatServiceæ ¸å¿ƒæœåŠ¡

è¿™æ˜¯æ•´ä¸ªå¯¹è¯è®°å¿†çš„æ ¸å¿ƒå®ç°ï¼š

```java
// æ¥è‡ªï¼šhttps://github.com/Mark7766/spring-ai-apps/blob/main/memory-llama/src/main/java/com/sandy/memory/ollama/ChatService.java
package com.sandy.memory.ollama;

import lombok.extern.slf4j.Slf4j;
import org.springframework.ai.chat.client.ChatClient;
import org.springframework.ai.chat.client.advisor.MessageChatMemoryAdvisor;
import org.springframework.ai.chat.memory.ChatMemory;
import org.springframework.ai.chat.memory.InMemoryChatMemory;
import org.springframework.stereotype.Service;
import reactor.core.publisher.Flux;

import java.util.*;

@Slf4j
@Service
public class ChatService {

    private final ChatClient.Builder chatClientBuilder;
    private final ChatMemory chatMemory;
    private final Set<String> conversationIdSet = new HashSet<>();

    public ChatService(ChatClient.Builder chatClientBuilder) {
        this.chatClientBuilder = chatClientBuilder;
        // â­ åˆå§‹åŒ–å†…å­˜èŠå¤©è®°å¿†
        this.chatMemory = new InMemoryChatMemory();
    }

    // åˆ›å»ºæ–°ä¼šè¯
    public String createConversation() {
        String conversationId = UUID.randomUUID().toString();
        conversationIdSet.add(conversationId);
        log.info("åˆ›å»ºæ–°ä¼šè¯: {}", conversationId);
        return conversationId;
    }

    // å‘é€æ¶ˆæ¯å¹¶è·å–æµå¼å“åº”
    public Flux<String> chat(String conversationId, String userMessage) {
        // â­ æ„å»ºå¸¦æœ‰è®°å¿†åŠŸèƒ½çš„ChatClient
        ChatClient chatClient = chatClientBuilder
            .defaultAdvisors(
                MessageChatMemoryAdvisor.builder(chatMemory)
                    .conversationId(conversationId)  // æŒ‡å®šä¼šè¯ID
                    .build()
            )
            .build();

        log.info("å¤„ç†ä¼šè¯ {} çš„æ¶ˆæ¯: {}", conversationId, userMessage);

        // â­ ä½¿ç”¨æµå¼è°ƒç”¨
        return chatClient.prompt()
            .user(userMessage)
            .stream()      // æµå¼è¾“å‡º
            .content()     // åªè·å–å†…å®¹
            .doOnNext(content -> {
                log.debug("æµå¼è¾“å‡º: {}", content);
            })
            .filter(content -> !content.isEmpty())
            .doOnError(e -> log.error("æµå¼è¾“å‡ºé”™è¯¯: {}", e.getMessage()));
    }

    // è·å–ä¼šè¯å†å²
    public List<ChatMessage> getChatHistory(String conversationId) {
        List<org.springframework.ai.chat.messages.Message> memoryMessages = 
            chatMemory.get(conversationId, 100);  // è·å–æœ€è¿‘100æ¡
        
        List<ChatMessage> history = new ArrayList<>();
        for (org.springframework.ai.chat.messages.Message msg : memoryMessages) {
            ChatMessage chatMsg = new ChatMessage();
            chatMsg.setRole(msg.getMessageType().getValue());
            chatMsg.setContent(msg.getContent());
            chatMsg.setTimestamp(System.currentTimeMillis());
            history.add(chatMsg);
        }
        
        return history;
    }

    // è·å–æ‰€æœ‰ä¼šè¯
    public List<String> getConversations() {
        return new ArrayList<>(conversationIdSet);
    }
}
```

**æ ¸å¿ƒä»£ç è§£æ**ï¼š

1. **ChatMemoryåˆå§‹åŒ–**ï¼š
   ```java
   this.chatMemory = new InMemoryChatMemory();
   ```
   ä½¿ç”¨å†…å­˜å­˜å‚¨ï¼Œé€‚åˆå•æœºåº”ç”¨ã€‚

2. **MessageChatMemoryAdvisor**ï¼š
   ```java
   MessageChatMemoryAdvisor.builder(chatMemory)
       .conversationId(conversationId)
       .build()
   ```
   è‡ªåŠ¨ç®¡ç†å†å²æ¶ˆæ¯çš„åŠ è½½å’Œä¿å­˜ã€‚

3. **æµå¼è¾“å‡º**ï¼š
   ```java
   return chatClient.prompt()
       .user(userMessage)
       .stream()      // â­ æµå¼è°ƒç”¨
       .content();
   ```
   è¿”å›`Flux<String>`ï¼Œé€å­—è¾“å‡ºã€‚

### 3.5 ChatControlleræ§åˆ¶å™¨

æä¾›RESTful APIï¼š

```java
// æ¥è‡ªï¼šhttps://github.com/Mark7766/spring-ai-apps/blob/main/memory-llama/src/main/java/com/sandy/memory/ollama/ChatController.java
package com.sandy.memory.ollama;

import lombok.extern.slf4j.Slf4j;
import org.springframework.http.MediaType;
import org.springframework.web.bind.annotation.*;
import reactor.core.publisher.Flux;
import java.util.List;

@Slf4j
@RestController
@RequestMapping("/api/chat")
public class ChatController {

    private final ChatService chatService;

    public ChatController(ChatService chatService) {
        this.chatService = chatService;
    }

    // åˆ›å»ºæ–°ä¼šè¯
    @PostMapping("/conversations")
    public String createConversation() {
        String conversationId = chatService.createConversation();
        log.info("åˆ›å»ºä¼šè¯: {}", conversationId);
        return conversationId;
    }

    // å‘é€æ¶ˆæ¯ï¼ˆæµå¼å“åº”ï¼‰
    @PostMapping(
        value = "/{conversationId}", 
        produces = MediaType.TEXT_EVENT_STREAM_VALUE  // â­ SSEå†…å®¹ç±»å‹
    )
    public Flux<String> sendMessage(
        @PathVariable String conversationId, 
        @RequestBody String message
    ) {
        log.info("ä¼šè¯ {} æ”¶åˆ°æ¶ˆæ¯: {}", conversationId, message);
        return chatService.chat(conversationId, message);
    }

    // è·å–ä¼šè¯å†å²
    @GetMapping("/{conversationId}/history")
    public List<ChatMessage> getHistory(@PathVariable String conversationId) {
        return chatService.getChatHistory(conversationId);
    }

    // è·å–æ‰€æœ‰ä¼šè¯åˆ—è¡¨
    @GetMapping("/conversations")
    public List<String> getConversations() {
        return chatService.getConversations();
    }
}
```

**APIè¯´æ˜**ï¼š

| æ¥å£ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `POST /api/chat/conversations` | åˆ›å»ºä¼šè¯ | è¿”å›ä¼šè¯ID |
| `POST /api/chat/{id}` | å‘é€æ¶ˆæ¯ | æµå¼è¿”å›AIå›å¤ |
| `GET /api/chat/{id}/history` | è·å–å†å² | è¿”å›å®Œæ•´å¯¹è¯è®°å½• |
| `GET /api/chat/conversations` | ä¼šè¯åˆ—è¡¨ | è¿”å›æ‰€æœ‰ä¼šè¯ID |

---

## 4. æµå¼è¾“å‡ºï¼ˆSSEï¼‰åŸç†

### 4.1 ä»€ä¹ˆæ˜¯SSEï¼Ÿ

**SSEï¼ˆServer-Sent Eventsï¼‰** æ˜¯ä¸€ç§æœåŠ¡å™¨å‘å®¢æˆ·ç«¯æ¨é€æ•°æ®çš„æŠ€æœ¯ã€‚

**ä¼ ç»Ÿè¯·æ±‚ vs SSE**ï¼š

```
ä¼ ç»ŸHTTPï¼š
å®¢æˆ·ç«¯ â†’ è¯·æ±‚ â†’ æœåŠ¡å™¨
å®¢æˆ·ç«¯ â† å®Œæ•´å“åº” â† æœåŠ¡å™¨
ï¼ˆä¸€æ¬¡æ€§ï¼Œç­‰å¾…æ—¶é—´é•¿ï¼‰

SSEï¼š
å®¢æˆ·ç«¯ â†’ è¯·æ±‚ â†’ æœåŠ¡å™¨
å®¢æˆ·ç«¯ â† æ•°æ®ç‰‡æ®µ1 â† æœåŠ¡å™¨
å®¢æˆ·ç«¯ â† æ•°æ®ç‰‡æ®µ2 â† æœåŠ¡å™¨
å®¢æˆ·ç«¯ â† æ•°æ®ç‰‡æ®µ3 â† æœåŠ¡å™¨
...
ï¼ˆæŒç»­æ¨é€ï¼Œå®æ—¶æ˜¾ç¤ºï¼‰
```

### 4.2 SSEæ•°æ®æ ¼å¼

SSEä½¿ç”¨ç‰¹æ®Šçš„æ–‡æœ¬æ ¼å¼ï¼š

```
data: ä½ 
data: å¥½
data: ï¼Œ
data: æˆ‘
data: æ˜¯
data: AI

data: [DONE]
```

æ¯ä¸ª`data:`è¡Œæ˜¯ä¸€ä¸ªäº‹ä»¶ï¼ŒåŒæ¢è¡Œè¡¨ç¤ºäº‹ä»¶ç»“æŸã€‚

### 4.3 Spring AIæµå¼è¾“å‡ºå®ç°

**æ ¸å¿ƒAPI**ï¼š

```java
// éæµå¼ï¼ˆç­‰å¾…å®Œæ•´å“åº”ï¼‰
String response = chatClient.prompt()
    .user("ä½ å¥½")
    .call()
    .content();

// æµå¼ï¼ˆé€å­—è¿”å›ï¼‰
Flux<String> stream = chatClient.prompt()
    .user("ä½ å¥½")
    .stream()       // â­ è¿”å›Flux
    .content();
```

**Fluxæ˜¯ä»€ä¹ˆï¼Ÿ**

Fluxæ˜¯Reactoræ¡†æ¶çš„å“åº”å¼ç±»å‹ï¼š

```java
Flux<String> flux = Flux.just("ä½ ", "å¥½", "ï¼");

flux.subscribe(word -> {
    System.out.print(word);  // è¾“å‡ºï¼šä½ å¥½ï¼
});
```

### 4.4 æµå¼å“åº”çš„ä¼˜åŠ¿

| ç»´åº¦ | éæµå¼ | æµå¼ |
|------|-------|------|
| **ç”¨æˆ·ä½“éªŒ** | ç­‰å¾…10ç§’çœ‹åˆ°å®Œæ•´å›å¤ | 1ç§’å°±å¼€å§‹æ˜¾ç¤º |
| **æ„ŸçŸ¥é€Ÿåº¦** | æ…¢ | å¿«ï¼ˆæ‰“å­—æœºæ•ˆæœï¼‰ |
| **å†…å­˜å ç”¨** | éœ€è¦ç¼“å­˜å®Œæ•´å“åº” | è¾¹ç”Ÿæˆè¾¹å‘é€ |
| **è¶…æ—¶é£é™©** | é«˜ï¼ˆé•¿æ–‡æœ¬å®¹æ˜“è¶…æ—¶ï¼‰ | ä½ï¼ˆæŒç»­è¿æ¥ï¼‰ |

**å®æµ‹å¯¹æ¯”**ï¼š

ç”Ÿæˆ1000å­—çš„æ–‡ç« ï¼š
- **éæµå¼**ï¼šç­‰å¾…15ç§’ â†’ ä¸€æ¬¡æ€§æ˜¾ç¤º
- **æµå¼**ï¼š1ç§’åå¼€å§‹æ˜¾ç¤º â†’ 15ç§’å†…é€å­—æ˜¾ç¤º

ç”¨æˆ·æ›´å–œæ¬¢æµå¼ï¼Œå› ä¸º"æœ‰ä¸œè¥¿åœ¨åŠ¨"ï¼

---

## 5. å‰ç«¯å®æ—¶æ¸²æŸ“å®ç°

### 5.1 å‰ç«¯æ ¸å¿ƒé€»è¾‘

å‰ç«¯éœ€è¦å¤„ç†SSEæµå¼æ•°æ®ï¼š

```javascript
// æ¥è‡ªï¼šhttps://github.com/Mark7766/spring-ai-apps/blob/main/memory-llama/src/main/resources/static/js/script.jsï¼ˆéƒ¨åˆ†ï¼‰

async function sendMessage(conversationId, message) {
    // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
    appendMessage('user', message);
    
    // åˆ›å»ºAIæ¶ˆæ¯å®¹å™¨
    const assistantDiv = document.createElement('div');
    assistantDiv.className = 'message assistant';
    chatBody.appendChild(assistantDiv);
    
    // â­ å‘èµ·æµå¼è¯·æ±‚
    const response = await fetch(`/api/chat/${conversationId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(message)
    });
    
    // â­ å¤„ç†æµå¼å“åº”
    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let messageBuffer = '';
    
    while (true) {
        const { value, done } = await reader.read();
        if (done) break;
        
        // è§£ç æ•°æ®
        const chunk = decoder.decode(value, { stream: true });
        
        // è§£æSSEæ ¼å¼
        const lines = chunk.split('\n\n');
        for (const line of lines) {
            if (line.startsWith('data:')) {
                const content = line.slice(5).trim();
                // â­ é€å­—è¿½åŠ åˆ°é¡µé¢
                messageBuffer += content;
                assistantDiv.textContent = messageBuffer;
                
                // è‡ªåŠ¨æ»šåŠ¨
                chatBody.scrollTop = chatBody.scrollHeight;
            }
        }
    }
}
```

**å…³é”®æ­¥éª¤**ï¼š

1. **è·å–ReadableStream**ï¼š
   ```javascript
   const reader = response.body.getReader();
   ```

2. **å¾ªç¯è¯»å–æ•°æ®**ï¼š
   ```javascript
   while (true) {
       const { value, done } = await reader.read();
       if (done) break;
       // å¤„ç†value...
   }
   ```

3. **è§£æSSEæ ¼å¼**ï¼š
   ```javascript
   if (line.startsWith('data:')) {
       const content = line.slice(5).trim();
   }
   ```

4. **å®æ—¶æ›´æ–°DOM**ï¼š
   ```javascript
   assistantDiv.textContent += content;
   ```

### 5.2 ä¼šè¯åˆ‡æ¢åŠŸèƒ½

æ”¯æŒå¤šä¼šè¯ç®¡ç†ï¼š

```javascript
// æ¥è‡ªï¼šhttps://github.com/Mark7766/spring-ai-apps/blob/main/memory-llama/src/main/resources/static/js/script.jsï¼ˆéƒ¨åˆ†ï¼‰

// åˆ›å»ºæ–°ä¼šè¯
async function createConversation() {
    const response = await fetch('/api/chat/conversations', {
        method: 'POST'
    });
    const conversationId = await response.text();
    
    // æ·»åŠ åˆ°ä¸‹æ‹‰åˆ—è¡¨
    const option = document.createElement('option');
    option.value = conversationId;
    option.textContent = `ä¼šè¯ ${conversationId.slice(0, 8)}...`;
    conversationSelect.appendChild(option);
    
    // åˆ‡æ¢åˆ°æ–°ä¼šè¯
    conversationSelect.value = conversationId;
    currentConversationId = conversationId;
    clearChatBody();
}

// åˆ‡æ¢ä¼šè¯
conversationSelect.addEventListener('change', async (e) => {
    currentConversationId = e.target.value;
    
    // åŠ è½½å†å²æ¶ˆæ¯
    const response = await fetch(`/api/chat/${currentConversationId}/history`);
    const history = await response.json();
    
    clearChatBody();
    history.forEach(msg => {
        appendMessage(msg.role, msg.content);
    });
});
```

**ç”¨æˆ·ä½“éªŒ**ï¼š
- âœ… å¤šä¼šè¯åˆ‡æ¢
- âœ… å†å²è®°å½•åŠ è½½
- âœ… ä¼šè¯æŒä¹…åŒ–

### 5.3 å®Œæ•´ç•Œé¢æ•ˆæœ

```html
<!-- æ¥è‡ªï¼šhttps://github.com/Mark7766/spring-ai-apps/blob/main/memory-llama/src/main/resources/static/index.htmlï¼ˆéƒ¨åˆ†ï¼‰ -->
<div class="container">
    <!-- ä¼šè¯ç®¡ç† -->
    <div class="header">
        <select id="conversation-select">
            <option value="">é€‰æ‹©ä¼šè¯</option>
        </select>
        <button id="new-conversation-btn">æ–°å»ºä¼šè¯</button>
    </div>
    
    <!-- èŠå¤©åŒºåŸŸ -->
    <div id="chat-body" class="chat-body">
        <!-- æ¶ˆæ¯åŠ¨æ€æ·»åŠ  -->
    </div>
    
    <!-- è¾“å…¥åŒºåŸŸ -->
    <div class="input-area">
        <textarea id="user-input" placeholder="è¾“å…¥æ¶ˆæ¯..."></textarea>
        <button id="send-btn">å‘é€</button>
    </div>
</div>
```

---

## 6. ä¼šè¯ç®¡ç†ä¸ä¼˜åŒ–

### 6.1 ä¼šè¯è¿‡æœŸç­–ç•¥

é•¿æ—¶é—´ä¸æ´»è·ƒçš„ä¼šè¯åº”è¯¥æ¸…ç†ï¼š

```java
@Service
public class ConversationCleanupService {
    
    private final Map<String, Long> lastActivityTime = new ConcurrentHashMap<>();
    private static final long EXPIRY_TIME = 30 * 60 * 1000; // 30åˆ†é’Ÿ
    
    @Scheduled(fixedRate = 60000) // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    public void cleanupExpiredConversations() {
        long now = System.currentTimeMillis();
        
        lastActivityTime.entrySet().removeIf(entry -> {
            if (now - entry.getValue() > EXPIRY_TIME) {
                String conversationId = entry.getKey();
                chatMemory.clear(conversationId);
                log.info("æ¸…ç†è¿‡æœŸä¼šè¯: {}", conversationId);
                return true;
            }
            return false;
        });
    }
    
    public void updateActivity(String conversationId) {
        lastActivityTime.put(conversationId, System.currentTimeMillis());
    }
}
```

### 6.2 å†…å­˜ä¼˜åŒ–

**é—®é¢˜**ï¼šå¯¹è¯è¶Šæ¥è¶Šé•¿ï¼Œå†…å­˜è¶Šæ¥è¶Šå¤§ï¼

**è§£å†³æ–¹æ¡ˆ1ï¼šæ»‘åŠ¨çª—å£**

```java
// åªä¿ç•™æœ€è¿‘10è½®å¯¹è¯
ChatMemory chatMemory = MessageWindowChatMemory.builder()
    .maxMessages(20)  // 10è½® = 20æ¡æ¶ˆæ¯ï¼ˆç”¨æˆ·+åŠ©æ‰‹ï¼‰
    .build();
```

**è§£å†³æ–¹æ¡ˆ2ï¼šæ¶ˆæ¯å‹ç¼©**

```java
@Service
public class MessageCompressor {
    
    public String compressHistory(List<Message> messages) {
        if (messages.size() <= 10) {
            return formatMessages(messages);
        }
        
        // ä¿ç•™æœ€è¿‘3è½®å®Œæ•´å¯¹è¯
        List<Message> recent = messages.subList(messages.size() - 6, messages.size());
        
        // å‹ç¼©æ›´æ—©çš„æ¶ˆæ¯
        List<Message> older = messages.subList(0, messages.size() - 6);
        String summary = summarize(older);
        
        return "[å†å²æ‘˜è¦: " + summary + "]\n\n" + formatMessages(recent);
    }
}
```

### 6.3 åˆ†å¸ƒå¼éƒ¨ç½²

**é—®é¢˜**ï¼šå¤šå®ä¾‹åº”ç”¨ï¼Œå†…å­˜ä¸å…±äº«ï¼

**è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨Redis**

```java
@Configuration
public class ChatMemoryConfig {
    
    @Bean
    public ChatMemory chatMemory(RedisTemplate<String, Object> redisTemplate) {
        return new RedisChatMemory(redisTemplate);
    }
}

@Service
public class RedisChatMemory implements ChatMemory {
    
    private final RedisTemplate<String, Object> redisTemplate;
    private static final String KEY_PREFIX = "chat:memory:";
    
    @Override
    public void add(String conversationId, Message message) {
        String key = KEY_PREFIX + conversationId;
        redisTemplate.opsForList().rightPush(key, message);
        // è®¾ç½®è¿‡æœŸæ—¶é—´
        redisTemplate.expire(key, 24, TimeUnit.HOURS);
    }
    
    @Override
    public List<Message> get(String conversationId, int lastN) {
        String key = KEY_PREFIX + conversationId;
        List<Object> messages = redisTemplate.opsForList().range(key, -lastN, -1);
        return messages.stream()
            .map(obj -> (Message) obj)
            .collect(Collectors.toList());
    }
}
```

### 6.4 ç›‘æ§ä¸æ—¥å¿—

**å…³é”®æŒ‡æ ‡**ï¼š

```java
@Service
public class ChatMetrics {
    
    private final MeterRegistry registry;
    
    public void recordConversation(String conversationId, int messageCount, long duration) {
        // ä¼šè¯æ¶ˆæ¯æ•°
        registry.counter("chat.messages", "conversation", conversationId)
                .increment(messageCount);
        
        // å“åº”æ—¶é—´
        registry.timer("chat.duration")
                .record(duration, TimeUnit.MILLISECONDS);
        
        // æ´»è·ƒä¼šè¯æ•°
        registry.gauge("chat.active.conversations", conversationIdSet.size());
    }
}
```

---

## ğŸ’» ç¤ºä¾‹ä»£ç 

å®Œæ•´é¡¹ç›®ä»£ç ï¼š[https://github.com/Mark7766/spring-ai-apps/tree/main/memory-llama](https://github.com/Mark7766/spring-ai-apps/tree/main/memory-llama)

**é¡¹ç›®ç»“æ„**ï¼š
```
memory-llama/
â”œâ”€â”€ src/main/java/com/sandy/memory/ollama/
â”‚   â”œâ”€â”€ MemoryLlamaApplication.java      # å¯åŠ¨ç±»
â”‚   â”œâ”€â”€ ChatController.java               # REST API
â”‚   â”œâ”€â”€ ChatService.java                  # æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
â”‚   â””â”€â”€ ChatMessage.java                  # æ¶ˆæ¯å®ä½“
â”œâ”€â”€ src/main/resources/
â”‚   â”œâ”€â”€ application.yml                   # é…ç½®æ–‡ä»¶
â”‚   â””â”€â”€ static/
â”‚       â”œâ”€â”€ index.html                    # èŠå¤©ç•Œé¢
â”‚       â”œâ”€â”€ js/script.js                  # å‰ç«¯é€»è¾‘
â”‚       â””â”€â”€ css/style.css                 # æ ·å¼
â””â”€â”€ pom.xml
```

---

## ğŸ¤” æ€è€ƒé¢˜

1. **å¦‚ä½•è®¾è®¡ä¼šè¯çš„è¿‡æœŸå’Œæ¸…ç†ç­–ç•¥ï¼Ÿ**
   
   æç¤ºï¼šè€ƒè™‘å›ºå®šæ—¶é—´è¿‡æœŸã€LRUæ·˜æ±°ã€æ‰‹åŠ¨æ¸…ç†ç­‰ç­–ç•¥ã€‚

2. **åœ¨æµå¼è¾“å‡ºä¸­å¦‚ä½•å¤„ç†é”™è¯¯å’Œä¸­æ–­ï¼Ÿ**
   
   æç¤ºï¼šä½¿ç”¨`.doOnError()`ã€`.onErrorResume()`ç­‰Reactoræ“ä½œç¬¦ã€‚

3. **å¤šç§Ÿæˆ·åœºæ™¯ä¸‹å¦‚ä½•éš”ç¦»ä¸åŒç”¨æˆ·çš„å¯¹è¯è®°å¿†ï¼Ÿ**
   
   æç¤ºï¼šconversationIdåŒ…å«userIdï¼ŒRedisä½¿ç”¨å‘½åç©ºé—´éš”ç¦»ã€‚

---

## ğŸ“– æ‹“å±•é˜…è¯»

- [Server-Sent Events (SSE) è§„èŒƒ](https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events)
- [Spring AI ChatMemoryæ–‡æ¡£](https://docs.spring.io/spring-ai/reference/api/chatclient.html#_chat_memory)
- [Project Reactorå“åº”å¼ç¼–ç¨‹](https://projectreactor.io/docs/core/release/reference/)
- [Ollamaå®˜æ–¹æ–‡æ¡£](https://ollama.ai/docs)

---

## â­ï¸ ä¸‹æœŸé¢„å‘Š

æ­å–œä½ å®Œæˆäº†å…¥é—¨ç¯‡çš„å­¦ä¹ ï¼ğŸ‰ ç°åœ¨ä½ å·²ç»æŒæ¡äº†ï¼š
- âœ… Spring AIåŸºç¡€åº”ç”¨æ­å»º
- âœ… å¤šæ¨¡å‹çµæ´»åˆ‡æ¢
- âœ… å¯¹è¯è®°å¿†ä¸æµå¼è¾“å‡º

**å…¥é—¨ç¯‡åˆ°æ­¤ç»“æŸï¼** ä¸‹ä¸€æœŸè¿›å…¥**è¿›é˜¶ç¯‡**ï¼Œæˆ‘ä»¬å°†å­¦ä¹ **å‘é‡åŒ–æ•°æ®ä¸Embedding**ï¼Œå¼€å¯AIè¯­ä¹‰æœç´¢çš„å¤§é—¨ï¼

**ä¸‹æœŸäº®ç‚¹**ï¼š
- ğŸ”¤ æ–‡æœ¬å‘é‡åŒ–æŠ€æœ¯
- ğŸ” è¯­ä¹‰ç›¸ä¼¼åº¦æœç´¢
- ğŸ“¦ Ollamaæœ¬åœ°Embeddingæ¨¡å‹
- ğŸ¯ æ–‡æ¡£æ™ºèƒ½æ£€ç´¢å®æˆ˜

æ•¬è¯·æœŸå¾…ï¼

---

**æ›´æ–°æ—¥æœŸ**ï¼š2025å¹´11æœˆ30æ—¥  
**çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ

