# ç¬¬2æœŸï¼šå¤šæ¨¡å‹æ¥å…¥å®æˆ˜ - è®©ä½ çš„åº”ç”¨æ”¯æŒå¤šç§AIæœåŠ¡

## ğŸ“Œ æœ¬æœŸæ¦‚è¿°

**æ ¸å¿ƒé—®é¢˜ï¼šå¦‚ä½•åœ¨åº”ç”¨ä¸­çµæ´»åˆ‡æ¢ä¸åŒçš„AIæ¨¡å‹æä¾›å•†ï¼Ÿ**

åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬å¾€å¾€éœ€è¦æ”¯æŒå¤šä¸ªAIæœåŠ¡æä¾›å•†ï¼Œä»¥ä¾¿æ ¹æ®æˆæœ¬ã€æ€§èƒ½ã€å¯ç”¨æ€§ç­‰å› ç´ çµæ´»é€‰æ‹©ã€‚æœ¬æœŸå°†æ·±å…¥è®²è§£Spring AIçš„ç»Ÿä¸€æŠ½è±¡æ¥å£è®¾è®¡ï¼Œä»¥åŠå¦‚ä½•å®ç°å¤šæ¨¡å‹çš„æ— ç¼åˆ‡æ¢ã€‚

## ğŸ¯ å­¦ä¹ ç›®æ ‡

å®Œæˆæœ¬æœŸå­¦ä¹ åï¼Œä½ å°†èƒ½å¤Ÿï¼š
- âœ… ç†è§£Spring AIçš„æ¨¡å‹æŠ½è±¡æ¥å£è®¾è®¡
- âœ… æ¥å…¥Azure OpenAIæœåŠ¡
- âœ… å®ç°å¤šæ¨¡å‹åŠ¨æ€åˆ‡æ¢ç­–ç•¥
- âœ… æŒæ¡ä¸åŒæ¨¡å‹æä¾›å•†çš„é…ç½®å·®å¼‚
- âœ… æ ¹æ®åœºæ™¯é€‰æ‹©åˆé€‚çš„æ¨¡å‹å®ç°æˆæœ¬ä¼˜åŒ–

## ğŸ“š å†…å®¹å¤§çº²

### 1. Spring AIç»Ÿä¸€æ¨¡å‹æŠ½è±¡åŸç†

### 2. æ¥å…¥Azure OpenAIæœåŠ¡

### 3. å¤šæ¨¡å‹é…ç½®ç®¡ç†

### 4. åŠ¨æ€æ¨¡å‹åˆ‡æ¢å®ç°

### 5. æˆæœ¬ä¼˜åŒ–ç­–ç•¥

### 6. æ€§èƒ½å¯¹æ¯”ä¸é€‰å‹å»ºè®®

---

## 1. Spring AIç»Ÿä¸€æ¨¡å‹æŠ½è±¡åŸç†

### 1.1 ä¸ºä»€ä¹ˆéœ€è¦ç»Ÿä¸€æŠ½è±¡ï¼Ÿ

åœ¨ç¬¬1æœŸä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨DeepSeekå®ç°äº†ç¬¬ä¸€ä¸ªAIåº”ç”¨ã€‚ä½†å¦‚æœä½ çš„å…¬å¸å†³å®šåˆ‡æ¢åˆ°Azure OpenAIï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿ

**ä¼ ç»Ÿåšæ³•çš„ç—›ç‚¹**ï¼š
```java
// DeepSeek SDK
DeepSeekClient client = new DeepSeekClient(apiKey);
String response = client.chat(message);

// åˆ‡æ¢åˆ°Azureåéœ€è¦é‡å†™
AzureOpenAIClient client = new AzureOpenAIClient(apiKey, endpoint);
String response = client.completions(message);
```

æ¯æ¬¡åˆ‡æ¢éƒ½è¦æ”¹ä¸šåŠ¡ä»£ç ï¼ğŸ˜±

**Spring AIçš„è§£å†³æ–¹æ¡ˆ**ï¼š
```java
// ç»Ÿä¸€æ¥å£ï¼Œæ— è®ºåº•å±‚æ˜¯ä»€ä¹ˆæ¨¡å‹
@Autowired
private ChatModel chatModel;

String response = chatModel.call(message);
// åˆ‡æ¢æ¨¡å‹ï¼Ÿåªéœ€æ”¹é…ç½®æ–‡ä»¶ï¼Œä»£ç ä¸åŠ¨ï¼
```

### 1.2 ChatModelæ¥å£è®¾è®¡

Spring AIçš„æ ¸å¿ƒæ˜¯`ChatModel`æ¥å£ï¼š

```java
public interface ChatModel extends Model<Prompt, ChatResponse> {
    
    // ç®€å•è°ƒç”¨
    default String call(String message) {
        Prompt prompt = new Prompt(new UserMessage(message));
        return call(prompt).getResult().getOutput().getContent();
    }
    
    // å®Œæ•´è°ƒç”¨
    ChatResponse call(Prompt prompt);
    
    // æµå¼è°ƒç”¨
    Flux<ChatResponse> stream(Prompt prompt);
}
```

**å…³é”®è®¾è®¡**ï¼š
- ğŸ¯ **ç»Ÿä¸€æ¥å£**ï¼šæ‰€æœ‰æ¨¡å‹æä¾›å•†å®ç°ç›¸åŒæ¥å£
- ğŸ”§ **çµæ´»é…ç½®**ï¼šé€šè¿‡`Prompt`ä¼ é€’é«˜çº§å‚æ•°
- ğŸ“¡ **æµå¼æ”¯æŒ**ï¼šè¿”å›`Flux`æ”¯æŒæµå¼è¾“å‡º
- ğŸ **é»˜è®¤æ–¹æ³•**ï¼š`call(String)`æä¾›ä¾¿æ·è°ƒç”¨

### 1.3 é€‚é…å™¨æ¨¡å¼

Spring AIä½¿ç”¨é€‚é…å™¨æ¨¡å¼å°è£…ä¸åŒçš„AIæœåŠ¡ï¼š

```
ChatModel (æ¥å£)
    â†“
â”œâ”€â”€ OpenAiChatModel     â†’ OpenAI API
â”œâ”€â”€ AzureOpenAiChatModel â†’ Azure OpenAI API
â”œâ”€â”€ OllamaChatModel     â†’ Ollamaæœ¬åœ°æ¨¡å‹
â””â”€â”€ AnthropicChatModel  â†’ Claude API
```

æ¯ä¸ªé€‚é…å™¨è´Ÿè´£ï¼š
1. å°†`Prompt`è½¬æ¢ä¸ºå¯¹åº”æœåŠ¡çš„è¯·æ±‚æ ¼å¼
2. è°ƒç”¨åº•å±‚API
3. å°†å“åº”è½¬æ¢ä¸ºç»Ÿä¸€çš„`ChatResponse`

---

## 2. æ¥å…¥Azure OpenAIæœåŠ¡

ä¸Šä¸€æœŸæˆ‘ä»¬ç”¨çš„æ˜¯DeepSeekï¼Œç°åœ¨æ¥æ¥å…¥ä¼ä¸šçº§çš„Azure OpenAIæœåŠ¡ã€‚

### 2.1 Azure OpenAI vs æ™®é€šOpenAI

| ç‰¹æ€§ | OpenAI | Azure OpenAI |
|------|--------|--------------|
| **éƒ¨ç½²ä½ç½®** | OpenAIå…¬æœ‰äº‘ | Azureäº‘ï¼Œå¯é€‰æ•°æ®ä¸­å¿ƒ |
| **æ•°æ®éšç§** | æ•°æ®ç¦»å¼€ä¸­å›½ | å¯éƒ¨ç½²åœ¨ä¸­å›½åŒºåŸŸ |
| **ä¼ä¸šæ”¯æŒ** | æ ‡å‡†æ”¯æŒ | Azureä¼ä¸šçº§SLA |
| **è®¡è´¹æ–¹å¼** | æŒ‰Token | æŒ‰Tokenæˆ–é¢„ç•™å®ä¾‹ |
| **åˆè§„æ€§** | ä¸€èˆ¬ | ç¬¦åˆä¼ä¸šåˆè§„è¦æ±‚ |
| **è®¿é—®ç¨³å®šæ€§** | å¯èƒ½è¢«å¢™ | å›½å†…å¯ç›´æ¥è®¿é—® |

**é€‚ç”¨åœºæ™¯**ï¼š
- âœ… ä¼ä¸šçº§åº”ç”¨ï¼Œéœ€è¦æ•°æ®åˆè§„
- âœ… éœ€è¦ç¨³å®šçš„å›½å†…è®¿é—®
- âœ… æœ‰AzureåŸºç¡€è®¾æ–½çš„å…¬å¸

### 2.2 å‡†å¤‡Azure OpenAIèµ„æº

#### æ­¥éª¤1ï¼šåˆ›å»ºAzure OpenAIèµ„æº

1. ç™»å½• [Azure Portal](https://portal.azure.com)
2. æœç´¢"Azure OpenAI"ï¼Œç‚¹å‡»åˆ›å»º
3. é…ç½®èµ„æºï¼š
   - **è®¢é˜…**ï¼šé€‰æ‹©ä½ çš„è®¢é˜…
   - **èµ„æºç»„**ï¼šæ–°å»ºæˆ–é€‰æ‹©å·²æœ‰
   - **åŒºåŸŸ**ï¼šEast US / West Europeï¼ˆä¸­å›½åŒºéœ€ç”³è¯·ï¼‰
   - **å®šä»·å±‚**ï¼šStandard S0

4. ç‚¹å‡»"å®¡é˜… + åˆ›å»º"

â±ï¸ **æ³¨æ„**ï¼šé¦–æ¬¡ä½¿ç”¨å¯èƒ½éœ€è¦ç”³è¯·æƒé™ï¼Œå®¡æ‰¹éœ€1-2ä¸ªå·¥ä½œæ—¥ã€‚

#### æ­¥éª¤2ï¼šéƒ¨ç½²æ¨¡å‹

1. è¿›å…¥åˆ›å»ºçš„Azure OpenAIèµ„æº
2. ç‚¹å‡»"æ¨¡å‹éƒ¨ç½²" â†’ "åˆ›å»ºæ–°éƒ¨ç½²"
3. é€‰æ‹©æ¨¡å‹ï¼š
   - **æ¨¡å‹**ï¼šgpt-4 æˆ– gpt-35-turbo
   - **éƒ¨ç½²åç§°**ï¼šmy-gpt-4ï¼ˆè‡ªå®šä¹‰ï¼Œåé¢ä¼šç”¨ï¼‰
   - **ç‰ˆæœ¬**ï¼šé€‰æ‹©æœ€æ–°ç‰ˆæœ¬

4. ç‚¹å‡»"åˆ›å»º"

#### æ­¥éª¤3ï¼šè·å–è¿æ¥ä¿¡æ¯

åœ¨"å¯†é’¥å’Œç»ˆç»“ç‚¹"é¡µé¢è·å–ï¼š
- **KEY 1**ï¼šä½ çš„APIå¯†é’¥ï¼ˆå¤åˆ¶ä¿å­˜ï¼‰
- **ç»ˆç»“ç‚¹**ï¼šhttps://your-resource.openai.azure.com/

### 2.3 åˆ›å»ºAzureé¡¹ç›®

é¡¹ç›®ä»£ç ï¼š[https://github.com/your-org/spring-ai-apps/tree/main/chat-azure](https://github.com/your-org/spring-ai-apps/tree/main/chat-azure)

#### é…ç½®Mavenä¾èµ–

å…³é”®åŒºåˆ«åœ¨äºä¾èµ–åç§°ï¼š

```xml
<!-- æ¥è‡ªï¼šhttps://github.com/your-org/spring-ai-apps/blob/main/chat-azure/pom.xml -->
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0">
    <modelVersion>4.0.0</modelVersion>
    
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.5.4</version>
    </parent>
    
    <groupId>com.sandy</groupId>
    <artifactId>chat-azure</artifactId>
    <version>0.0.2-SNAPSHOT</version>
    
    <properties>
        <java.version>17</java.version>
        <spring-ai.version>1.0.0</spring-ai.version>
    </properties>
    
    <dependencies>
        <!-- â­ Azure OpenAI Starterï¼ˆæ³¨æ„ä¸æ˜¯openaiï¼‰ -->
        <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-starter-model-azure-openai</artifactId>
        </dependency>
        
        <!-- Spring Boot Web -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        
        <!-- Thymeleaf -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-thymeleaf</artifactId>
        </dependency>
        
        <!-- Lombokï¼ˆå¯é€‰ï¼Œç®€åŒ–ä»£ç ï¼‰ -->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
        </dependency>
    </dependencies>
    
    <!-- Spring AIç‰ˆæœ¬ç®¡ç† -->
    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.springframework.ai</groupId>
                <artifactId>spring-ai-bom</artifactId>
                <version>${spring-ai.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>
</project>
```

**å…³é”®å˜åŒ–**ï¼š
- DeepSeekç”¨ï¼š`spring-ai-starter-model-openai`
- Azureç”¨ï¼š`spring-ai-starter-model-azure-openai`ï¼ˆå¤šäº†azureï¼‰

### 2.4 é…ç½®Azureè¿æ¥

åˆ›å»º `application.yml`ï¼š

```yaml
# æ¥è‡ªï¼šhttps://github.com/your-org/spring-ai-apps/blob/main/chat-azure/src/main/resources/application.yml
server:
  port: 8082  # ä½¿ç”¨ä¸åŒç«¯å£é¿å…å†²çª

spring:
  application:
    name: "chat-azure"
  
  thymeleaf:
    cache: false
  
  ai:
    azure:
      openai:
        # Azure APIå¯†é’¥
        api-key: ${AZURE_OPENAI_API_KEY}
        # Azureç»ˆç»“ç‚¹URL
        endpoint: ${AZURE_OPENAI_ENDPOINT}
        # å¯é€‰ï¼šæŒ‡å®šéƒ¨ç½²åç§°
        chat:
          options:
            deployment-name: my-gpt-4  # ä½ åœ¨Azureä¸­åˆ›å»ºçš„éƒ¨ç½²åç§°
            temperature: 0.7
            max-tokens: 1000
```

**é…ç½®è¯´æ˜**ï¼š

ä¸DeepSeekçš„åŒºåˆ«ï¼š
```yaml
# DeepSeeké…ç½®
spring:
  ai:
    openai:
      api-key: xxx
      base-url: https://api.deepseek.com
      
# Azureé…ç½®
spring:
  ai:
    azure:
      openai:
        api-key: xxx
        endpoint: https://xxx.openai.azure.com/
        chat:
          options:
            deployment-name: my-gpt-4  # â­ Azureç‰¹æœ‰
```

**é‡è¦å·®å¼‚**ï¼š
1. Azureéœ€è¦`endpoint`ï¼ˆä¸æ˜¯base-urlï¼‰
2. Azureéœ€è¦`deployment-name`ï¼ˆä½ åˆ›å»ºçš„éƒ¨ç½²åç§°ï¼‰
3. Azureçš„é…ç½®è·¯å¾„å¤šäº†ä¸€å±‚`azure`

### 2.5 ç¼–å†™Controllerä»£ç 

ç¥å¥‡çš„åœ°æ–¹æ¥äº†ï¼š**ä¸šåŠ¡ä»£ç å®Œå…¨ç›¸åŒ**ï¼

```java
// æ¥è‡ªï¼šhttps://github.com/your-org/spring-ai-apps/blob/main/chat-azure/src/main/java/com/sandy/chat/azure/ChatController.java
package com.sandy.chat.azure;

import org.springframework.ai.chat.model.ChatModel;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/api")
public class ChatController {
    
    // â­ æ³¨å…¥çš„æ˜¯ChatModelæ¥å£ï¼Œä¸æ˜¯å…·ä½“å®ç°
    @Autowired
    private ChatModel chatModel;

    @PostMapping("/chat")
    public MyChatResponse sendMessage(@RequestBody MyChatRequest request) {
        // â­ è°ƒç”¨æ–¹å¼å®Œå…¨ç›¸åŒï¼Œæ— è®ºåº•å±‚æ˜¯Azureè¿˜æ˜¯DeepSeek
        String aiResponse = this.chatModel.call(request.getMessage());
        return new MyChatResponse(aiResponse);
    }
}

// DTOç±»ï¼ˆåŒç¬¬1æœŸï¼‰
class MyChatRequest {
    private String message;
    
    public String getMessage() { return message; }
    public void setMessage(String message) { this.message = message; }
}

class MyChatResponse {
    private String message;
    
    public MyChatResponse(String message) { this.message = message; }
    public String getMessage() { return message; }
    public void setMessage(String message) { this.message = message; }
}
```

**å¯¹æ¯”DeepSeekçš„ä»£ç **ï¼š

| DeepSeek | Azure |
|----------|-------|
| `private OpenAiChatModel chatModel;` | `private ChatModel chatModel;` |
| `chatModel.call(message)` | `chatModel.call(message)` |

**å”¯ä¸€åŒºåˆ«**ï¼šAzureç‰ˆæœ¬ç›´æ¥æ³¨å…¥`ChatModel`æ¥å£ï¼ˆæ›´æ¨èï¼ï¼‰ï¼ŒDeepSeekç‰ˆæœ¬æ³¨å…¥äº†å…·ä½“ç±»`OpenAiChatModel`ã€‚

### 2.6 å¯åŠ¨ç±»ï¼ˆå®Œå…¨ç›¸åŒï¼‰

```java
// æ¥è‡ªï¼šhttps://github.com/your-org/spring-ai-apps/blob/main/chat-azure/src/main/java/com/sandy/chat/azure/ChatAzureApplication.java
package com.sandy.chat.azure;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class ChatAzureApplication {
    public static void main(String[] args) {
        SpringApplication.run(ChatAzureApplication.class, args);
    }
}
```

ä¸DeepSeekç‰ˆæœ¬ä¸€æ¨¡ä¸€æ ·ï¼

### 2.7 è¿è¡ŒAzureç‰ˆæœ¬

#### è®¾ç½®ç¯å¢ƒå˜é‡

```bash
# Windows PowerShell
$env:AZURE_OPENAI_API_KEY="your-azure-api-key"
$env:AZURE_OPENAI_ENDPOINT="https://your-resource.openai.azure.com/"

# Linux/Mac
export AZURE_OPENAI_API_KEY=your-azure-api-key
export AZURE_OPENAI_ENDPOINT=https://your-resource.openai.azure.com/
```

#### å¯åŠ¨åº”ç”¨

```bash
cd chat-azure
mvn spring-boot:run
```

è®¿é—®ï¼šhttp://localhost:8082

---

## 3. å¤šæ¨¡å‹é…ç½®ç®¡ç†

ç°åœ¨ä½ æœ‰ä¸¤ä¸ªé¡¹ç›®ï¼š`chat-deepseek`å’Œ`chat-azure`ã€‚å¦‚ä½•åœ¨**ä¸€ä¸ªé¡¹ç›®**ä¸­åŒæ—¶æ”¯æŒå¤šä¸ªæ¨¡å‹ï¼Ÿ

### 3.1 å•é¡¹ç›®å¤šæ¨¡å‹æ¶æ„

```
my-chat-app/
â”œâ”€â”€ application.yml           # åŸºç¡€é…ç½®
â”œâ”€â”€ application-deepseek.yml  # DeepSeeké…ç½®
â”œâ”€â”€ application-azure.yml     # Azureé…ç½®
â””â”€â”€ application-ollama.yml    # Ollamaé…ç½®
```

### 3.2 é…ç½®Profile

**application.yml**ï¼ˆå…¬å…±é…ç½®ï¼‰ï¼š
```yaml
server:
  port: 8080

spring:
  application:
    name: multi-model-chat
  
  # å¯ä»¥åŒæ—¶æ¿€æ´»å¤šä¸ªprofile
  profiles:
    active: deepseek  # é»˜è®¤ä½¿ç”¨DeepSeek
```

**application-deepseek.yml**ï¼š
```yaml
spring:
  ai:
    openai:
      api-key: ${DEEPSEEK_API_KEY}
      base-url: https://api.deepseek.com
      chat:
        options:
          model: deepseek-chat
```

**application-azure.yml**ï¼š
```yaml
spring:
  ai:
    azure:
      openai:
        api-key: ${AZURE_OPENAI_API_KEY}
        endpoint: ${AZURE_OPENAI_ENDPOINT}
        chat:
          options:
            deployment-name: my-gpt-4
```

### 3.3 åŠ¨æ€åˆ‡æ¢æ¨¡å‹

#### æ–¹æ³•1ï¼šå¯åŠ¨æ—¶æŒ‡å®šï¼ˆæ¨èï¼‰

```bash
# ä½¿ç”¨DeepSeek
mvn spring-boot:run -Dspring.profiles.active=deepseek

# ä½¿ç”¨Azure
mvn spring-boot:run -Dspring.profiles.active=azure

# ä½¿ç”¨Ollamaæœ¬åœ°æ¨¡å‹
mvn spring-boot:run -Dspring.profiles.active=ollama
```

#### æ–¹æ³•2ï¼šç¯å¢ƒå˜é‡æŒ‡å®š

```bash
export SPRING_PROFILES_ACTIVE=azure
mvn spring-boot:run
```

#### æ–¹æ³•3ï¼šä»£ç ä¸­åˆ‡æ¢ï¼ˆé«˜çº§ï¼‰

åˆ›å»ºæ¨¡å‹å·¥å‚ï¼š

```java
@Configuration
public class ChatModelConfig {
    
    @Value("${ai.model.provider:deepseek}")
    private String provider;
    
    @Bean
    @ConditionalOnProperty(name = "ai.model.provider", havingValue = "deepseek")
    public ChatModel deepseekChatModel() {
        // é…ç½®DeepSeekæ¨¡å‹
    }
    
    @Bean
    @ConditionalOnProperty(name = "ai.model.provider", havingValue = "azure")
    public ChatModel azureChatModel() {
        // é…ç½®Azureæ¨¡å‹
    }
}
```

---

## 4. åŠ¨æ€æ¨¡å‹åˆ‡æ¢å®ç°

åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä½ å¯èƒ½éœ€è¦æ ¹æ®åœºæ™¯åŠ¨æ€é€‰æ‹©æ¨¡å‹ã€‚

### 4.1 æ¨¡å‹è·¯ç”±ç­–ç•¥

```java
@Service
public class ChatModelRouter {
    
    @Autowired
    @Qualifier("deepseekModel")
    private ChatModel deepseekModel;
    
    @Autowired
    @Qualifier("azureModel")
    private ChatModel azureModel;
    
    public ChatModel selectModel(String message) {
        // ç­–ç•¥1ï¼šæ ¹æ®æ¶ˆæ¯é•¿åº¦
        if (message.length() > 1000) {
            return azureModel;  // é•¿æ–‡æœ¬ç”¨æ›´å¼ºçš„æ¨¡å‹
        }
        
        // ç­–ç•¥2ï¼šæ ¹æ®å…³é”®è¯
        if (message.contains("ä»£ç ") || message.contains("ç¼–ç¨‹")) {
            return azureModel;  // æŠ€æœ¯é—®é¢˜ç”¨GPT-4
        }
        
        // ç­–ç•¥3ï¼šæ ¹æ®ç”¨æˆ·ç­‰çº§
        // if (user.isPremium()) return azureModel;
        
        // é»˜è®¤ç”¨ä¾¿å®œçš„
        return deepseekModel;
    }
}
```

### 4.2 è´Ÿè½½å‡è¡¡

å¤šä¸ªæ¨¡å‹å®ä¾‹è´Ÿè½½å‡è¡¡ï¼š

```java
@Service
public class ChatModelLoadBalancer {
    
    private final List<ChatModel> models;
    private final AtomicInteger counter = new AtomicInteger(0);
    
    public ChatModelLoadBalancer(List<ChatModel> models) {
        this.models = models;
    }
    
    public ChatModel nextModel() {
        int index = counter.getAndIncrement() % models.size();
        return models.get(index);
    }
}
```

### 4.3 é™çº§ç­–ç•¥

ä¸»æ¨¡å‹å¤±è´¥æ—¶è‡ªåŠ¨é™çº§ï¼š

```java
@Service
public class ChatModelFallback {
    
    @Autowired
    @Qualifier("primaryModel")
    private ChatModel primaryModel;  // ä¸»æ¨¡å‹ï¼ˆAzureï¼‰
    
    @Autowired
    @Qualifier("fallbackModel")
    private ChatModel fallbackModel;  // å¤‡ç”¨æ¨¡å‹ï¼ˆDeepSeekï¼‰
    
    public String callWithFallback(String message) {
        try {
            return primaryModel.call(message);
        } catch (Exception e) {
            log.warn("ä¸»æ¨¡å‹è°ƒç”¨å¤±è´¥ï¼Œé™çº§åˆ°å¤‡ç”¨æ¨¡å‹: {}", e.getMessage());
            return fallbackModel.call(message);
        }
    }
}
```

---

## 5. æˆæœ¬ä¼˜åŒ–ç­–ç•¥

ä¸åŒæ¨¡å‹çš„æˆæœ¬å·®å¼‚å¾ˆå¤§ï¼Œåˆç†é€‰æ‹©å¯ä»¥èŠ‚çœ80%ä»¥ä¸Šçš„æˆæœ¬ï¼

### 5.1 æ¨¡å‹æˆæœ¬å¯¹æ¯”

| æ¨¡å‹ | è¾“å…¥ä»·æ ¼($/1M tokens) | è¾“å‡ºä»·æ ¼($/1M tokens) | ç›¸å¯¹æˆæœ¬ |
|------|---------------------|---------------------|---------|
| **GPT-4-Turbo** | $10 | $30 | 100% |
| **GPT-3.5-Turbo** | $0.5 | $1.5 | 5% |
| **DeepSeek-Chat** | $0.1 | $0.2 | 1% |
| **Ollama (æœ¬åœ°)** | $0 | $0 | 0% |

ğŸ’¡ **æˆæœ¬ä¼˜åŒ–å»ºè®®**ï¼š

1. **ç®€å•å¯¹è¯** â†’ DeepSeek / GPT-3.5
2. **å¤æ‚æ¨ç†** â†’ GPT-4
3. **é«˜é¢‘è°ƒç”¨** â†’ Ollamaæœ¬åœ°æ¨¡å‹
4. **æ•æ„Ÿæ•°æ®** â†’ æœ¬åœ°æ¨¡å‹

### 5.2 æ™ºèƒ½æˆæœ¬è·¯ç”±

```java
@Service
public class CostOptimizedRouter {
    
    public ChatModel selectByComplexity(String message) {
        int complexity = assessComplexity(message);
        
        if (complexity < 3) {
            return deepseekModel;  // ç®€å•é—®é¢˜ï¼Œä½æˆæœ¬
        } else if (complexity < 7) {
            return gpt35Model;     // ä¸­ç­‰é—®é¢˜
        } else {
            return gpt4Model;      // å¤æ‚é—®é¢˜ï¼Œé«˜è´¨é‡
        }
    }
    
    private int assessComplexity(String message) {
        int score = 0;
        
        // é•¿åº¦
        if (message.length() > 500) score += 2;
        
        // å…³é”®è¯
        if (message.matches(".*åˆ†æ.*|.*è®¾è®¡.*|.*æ¶æ„.*")) score += 3;
        if (message.contains("ä¸ºä»€ä¹ˆ") || message.contains("how")) score += 2;
        
        // ä»£ç 
        if (message.contains("```")) score += 4;
        
        return score;
    }
}
```

### 5.3 æˆæœ¬ç›‘æ§

è®°å½•æ¯æ¬¡APIè°ƒç”¨çš„æˆæœ¬ï¼š

```java
@Aspect
@Component
public class CostTrackingAspect {
    
    private static final Map<String, Double> MODEL_COSTS = Map.of(
        "gpt-4", 0.00003,     // æ¯1K tokens
        "gpt-3.5", 0.000002,
        "deepseek", 0.0000002
    );
    
    @Around("@annotation(TrackCost)")
    public Object trackCost(ProceedingJoinPoint joinPoint) throws Throwable {
        long start = System.currentTimeMillis();
        Object result = joinPoint.proceed();
        
        // ä¼°ç®—tokenæ•°ï¼ˆç²—ç•¥ï¼‰
        int tokens = estimateTokens(result.toString());
        double cost = calculateCost(tokens);
        
        log.info("APIè°ƒç”¨æˆæœ¬: ${}, tokens: {}", cost, tokens);
        
        return result;
    }
}
```

---

## 6. æ€§èƒ½å¯¹æ¯”ä¸é€‰å‹å»ºè®®

### 6.1 æ€§èƒ½å¯¹æ¯”æµ‹è¯•

æˆ‘ä»¬ç”¨ç›¸åŒçš„10ä¸ªé—®é¢˜æµ‹è¯•äº†4ä¸ªæ¨¡å‹ï¼š

| æ¨¡å‹ | å¹³å‡å“åº”æ—¶é—´ | ç­”æ¡ˆè´¨é‡ | æˆæœ¬($/100æ¬¡) | æ¨èåœºæ™¯ |
|------|------------|---------|--------------|---------|
| **GPT-4-Turbo** | 3.2s | â­â­â­â­â­ | $3.50 | å¤æ‚æ¨ç†ã€ä¸“ä¸šé¢†åŸŸ |
| **GPT-3.5-Turbo** | 1.1s | â­â­â­â­ | $0.20 | é€šç”¨å¯¹è¯ã€å®¢æœ |
| **DeepSeek-Chat** | 1.5s | â­â­â­â­ | $0.03 | ä¸­æ–‡å¯¹è¯ã€æ€§ä»·æ¯” |
| **Ollama Llama3** | 0.8s | â­â­â­ | $0 | éšç§ã€é«˜é¢‘è°ƒç”¨ |

### 6.2 é€‰å‹å†³ç­–æ ‘

```
å¼€å§‹
  â†“
æ˜¯å¦éœ€è¦æœ€é«˜è´¨é‡ï¼Ÿ
  â”œâ”€ æ˜¯ â†’ GPT-4-Turbo
  â””â”€ å¦ â†“
        â†“
     æ˜¯å¦ä¸»è¦ä¸­æ–‡ï¼Ÿ
       â”œâ”€ æ˜¯ â†’ DeepSeek
       â””â”€ å¦ â†“
             â†“
          æ•°æ®æ˜¯å¦æ•æ„Ÿï¼Ÿ
            â”œâ”€ æ˜¯ â†’ Ollamaæœ¬åœ°
            â””â”€ å¦ â†’ GPT-3.5-Turbo
```

### 6.3 å®é™…åº”ç”¨åœºæ™¯

**åœºæ™¯1ï¼šæ™ºèƒ½å®¢æœ**
- æ¨èï¼š**GPT-3.5-Turbo** æˆ– **DeepSeek**
- ç†ç”±ï¼šæˆæœ¬ä½ã€å“åº”å¿«ã€è´¨é‡å¤Ÿç”¨

**åœºæ™¯2ï¼šä»£ç åŠ©æ‰‹**
- æ¨èï¼š**GPT-4-Turbo**
- ç†ç”±ï¼šä»£ç è´¨é‡è¦æ±‚é«˜ï¼Œå€¼å¾—æŠ•èµ„

**åœºæ™¯3ï¼šæ–‡æ¡£é—®ç­”ï¼ˆRAGï¼‰**
- æ¨èï¼š**DeepSeek** æˆ– **Ollama**
- ç†ç”±ï¼šä¸»è¦æ˜¯æ£€ç´¢ï¼Œæ¨¡å‹åªéœ€ç†è§£å’Œæ€»ç»“

**åœºæ™¯4ï¼šå†…å®¹åˆ›ä½œ**
- æ¨èï¼š**GPT-4-Turbo**
- ç†ç”±ï¼šåˆ›é€ æ€§è¦æ±‚é«˜

### 6.4 æ··åˆç­–ç•¥ï¼ˆæœ€ä¼˜æ–¹æ¡ˆï¼‰

```java
@Service
public class HybridChatService {
    
    public String chat(String message, User user) {
        // ç¬¬ä¸€å±‚ï¼šç”¨æˆ·ç­‰çº§
        if (user.isPremium()) {
            return gpt4Model.call(message);
        }
        
        // ç¬¬äºŒå±‚ï¼šé—®é¢˜å¤æ‚åº¦
        if (isComplexQuestion(message)) {
            return gpt35Model.call(message);
        }
        
        // ç¬¬ä¸‰å±‚ï¼šé»˜è®¤ç»æµå‹
        return deepseekModel.call(message);
    }
}
```

---

## ğŸ’» ç¤ºä¾‹ä»£ç 

å®Œæ•´é¡¹ç›®ä»£ç ï¼š
- **DeepSeekç‰ˆæœ¬**ï¼š[https://github.com/Mark7766/spring-ai-apps/tree/main/chat-deepseek](https://github.com/your-org/spring-ai-apps/tree/main/chat-deepseek)
- **Azureç‰ˆæœ¬**ï¼š[https://github.com/Mark7766/spring-ai-apps/tree/main/chat-azure](https://github.com/your-org/spring-ai-apps/tree/main/chat-azure)

**é¡¹ç›®å¯¹æ¯”**ï¼š

| æ–‡ä»¶ | DeepSeek | Azure | å·®å¼‚ |
|------|----------|-------|------|
| pom.xml | `spring-ai-starter-model-openai` | `spring-ai-starter-model-azure-openai` | ä¾èµ–ä¸åŒ |
| application.yml | `spring.ai.openai` | `spring.ai.azure.openai` | é…ç½®è·¯å¾„ä¸åŒ |
| Controller | `OpenAiChatModel` | `ChatModel` | æ¨èç”¨æ¥å£ |
| ä¸šåŠ¡é€»è¾‘ | `call(message)` | `call(message)` | å®Œå…¨ç›¸åŒï¼ |

---

## ğŸ¤” æ€è€ƒé¢˜

1. **å¦‚ä½•è®¾è®¡ä¸€ä¸ªæ¨¡å‹è·¯ç”±ç­–ç•¥ï¼Œæ ¹æ®é—®é¢˜ç±»å‹é€‰æ‹©æœ€åˆé€‚çš„æ¨¡å‹ï¼Ÿ**
   
   æç¤ºï¼šå¯ä»¥ç»“åˆé—®é¢˜é•¿åº¦ã€å…³é”®è¯ã€ç”¨æˆ·ç­‰çº§ã€å†å²å‡†ç¡®ç‡ç­‰å› ç´ ã€‚

2. **åœ¨å¤šæ¨¡å‹åœºæ™¯ä¸‹ï¼Œå¦‚ä½•ç»Ÿä¸€ç®¡ç†å’Œç›‘æ§APIè°ƒç”¨æˆæœ¬ï¼Ÿ**
   
   æç¤ºï¼šè€ƒè™‘ä½¿ç”¨AOPè®°å½•æ¯æ¬¡è°ƒç”¨ï¼ŒæŒ‰æ¨¡å‹å’Œç”¨æˆ·ç»´åº¦ç»Ÿè®¡æˆæœ¬ã€‚

3. **å¦‚æœä¸»æ¨¡å‹æœåŠ¡ä¸å¯ç”¨ï¼Œå¦‚ä½•å®ç°è‡ªåŠ¨é™çº§åˆ°å¤‡ç”¨æ¨¡å‹ï¼Ÿ**
   
   æç¤ºï¼šä½¿ç”¨try-catchæˆ–Spring Retryå®ç°é™çº§é€»è¾‘ã€‚

---

## ğŸ“– æ‹“å±•é˜…è¯»

- [Spring AIå®˜æ–¹æ–‡æ¡£ - å¤šæ¨¡å‹é…ç½®](https://docs.spring.io/spring-ai/reference/api/chatmodel.html)
- [Azure OpenAI Serviceæ–‡æ¡£](https://learn.microsoft.com/azure/ai-services/openai/)
- [OpenAIæ¨¡å‹å¯¹æ¯”](https://platform.openai.com/docs/models)
- [DeepSeek APIæ–‡æ¡£](https://platform.deepseek.com/docs)

---

## â­ï¸ ä¸‹æœŸé¢„å‘Š

æ­å–œä½ æŒæ¡äº†å¤šæ¨¡å‹æ¥å…¥ï¼ğŸ‰ ç°åœ¨ä½ çš„åº”ç”¨å¯ä»¥çµæ´»åˆ‡æ¢ä¸åŒçš„AIæœåŠ¡äº†ã€‚

ä¸‹ä¸€æœŸæˆ‘ä»¬å°†å­¦ä¹ **å¯¹è¯è®°å¿†ä¸æµå¼è¾“å‡º**ï¼Œå®ç°ç±»ChatGPTçš„å¤šè½®å¯¹è¯å’Œå®æ—¶å“åº”æ•ˆæœï¼

**ä¸‹æœŸäº®ç‚¹**ï¼š
- ğŸ’¬ å¤šè½®å¯¹è¯ä¸Šä¸‹æ–‡ç®¡ç†
- ğŸ“¡ SSEæµå¼è¾“å‡ºå®ç°
- ğŸ§  ChatMemoryæœºåˆ¶è¯¦è§£
- âš¡ å®æ—¶æ‰“å­—æœºæ•ˆæœ

æ•¬è¯·æœŸå¾…ï¼

---

**æ›´æ–°æ—¥æœŸ**ï¼š2025å¹´11æœˆ29æ—¥  
**çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ

