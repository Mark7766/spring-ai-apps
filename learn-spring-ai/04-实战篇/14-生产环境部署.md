# ç¬¬14æœŸï¼šç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ä¸è¿ç»´ - è®©AIåº”ç”¨ç¨³å®šä¸Šçº¿

## ğŸ“Œ æœ¬æœŸæ¦‚è¿°

**æ ¸å¿ƒé—®é¢˜ï¼šå¦‚ä½•å°†AIåº”ç”¨ä»å¼€å‘ç¯å¢ƒç¨³å®šéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼Ÿ**

å¼€å‘å®Œæˆåªæ˜¯ç¬¬ä¸€æ­¥ï¼ŒçœŸæ­£çš„æŒ‘æˆ˜åœ¨äºéƒ¨ç½²å’Œè¿ç»´ã€‚æœ¬æœŸå°†æ·±å…¥è®²è§£Dockeré•œåƒæ„å»ºã€Kuberneteséƒ¨ç½²ã€CI/CDæµæ°´çº¿ã€ç›‘æ§å‘Šè­¦ã€ç°åº¦å‘å¸ƒç­‰ç”Ÿäº§ç¯å¢ƒå¿…å¤‡æŠ€èƒ½ï¼Œè®©ä½ çš„AIåº”ç”¨çœŸæ­£æœåŠ¡äºç”¨æˆ·ã€‚

## ğŸ¯ å­¦ä¹ ç›®æ ‡

å®Œæˆæœ¬æœŸå­¦ä¹ åï¼Œä½ å°†èƒ½å¤Ÿï¼š
- âœ… æ„å»ºç”Ÿäº§çº§çš„Dockeré•œåƒ
- âœ… ç¼–å†™å®Œæ•´çš„Kuberneteséƒ¨ç½²é…ç½®
- âœ… æ­å»ºCI/CDè‡ªåŠ¨åŒ–æµæ°´çº¿
- âœ… å®ç°æ»šåŠ¨æ›´æ–°å’Œç°åº¦å‘å¸ƒ
- âœ… é…ç½®ç›‘æ§å‘Šè­¦ä½“ç³»
- âœ… å¤„ç†ç”Ÿäº§ç¯å¢ƒçš„å¸¸è§é—®é¢˜

## ğŸ“š å†…å®¹å¤§çº²

### 1. Dockeré•œåƒæ„å»ºå®æˆ˜

### 2. Kuberneteså®Œæ•´éƒ¨ç½²æ–¹æ¡ˆ

### 3. CI/CDè‡ªåŠ¨åŒ–æµæ°´çº¿

### 4. ç›‘æ§å‘Šè­¦ä½“ç³»æ­å»º

### 5. ç°åº¦å‘å¸ƒä¸å›æ»š

### 6. ç”Ÿäº§ç¯å¢ƒæ•…éšœå¤„ç†

---

## 1. Dockeré•œåƒæ„å»ºå®æˆ˜

### 1.1 ä¸ºä»€ä¹ˆéœ€è¦å®¹å™¨åŒ–ï¼Ÿ

**å®¹å™¨åŒ–çš„ä¼˜åŠ¿**ï¼š

| å¯¹æ¯”ç»´åº¦ | ä¼ ç»Ÿéƒ¨ç½² | Dockerå®¹å™¨ |
|---------|---------|-----------|
| **ç¯å¢ƒä¸€è‡´æ€§** | "æˆ‘è¿™èƒ½è·‘ï¼Œä½ é‚£ä¸ºå•¥ä¸è¡Œï¼Ÿ" | å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§å®Œå…¨ä¸€è‡´ |
| **éƒ¨ç½²é€Ÿåº¦** | æ•°å°æ—¶ | æ•°ç§’ |
| **èµ„æºåˆ©ç”¨** | ä¸€å°æœåŠ¡å™¨ä¸€ä¸ªåº”ç”¨ | ä¸€å°æœåŠ¡å™¨è¿è¡Œå¤šä¸ªå®¹å™¨ |
| **æ‰©å±•æ€§** | æ‰‹åŠ¨æ·»åŠ æœºå™¨ | è‡ªåŠ¨æ°´å¹³æ‰©å±• |
| **ç‰ˆæœ¬å›æ»š** | å¤æ‚ | ä¸€é”®å›æ»š |

### 1.2 Dockerfileç¼–å†™

ä»¥newstoné¡¹ç›®ä¸ºä¾‹ï¼Œå±•ç¤ºç”Ÿäº§çº§Dockerfileï¼š

```dockerfile
# æ¥è‡ªï¼šhttps://github.com/Mark7766/spring-ai-apps/blob/main/newston/Dockerfile
FROM openjdk:17-oracle

# è®¾ç½®å®¹å™¨å†…å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶ç¼–è¯‘å¥½çš„JARåŒ…
COPY target/newston-0.0.1-SNAPSHOT.jar /app/application.jar

# å£°æ˜åº”ç”¨ç«¯å£
EXPOSE 8081

# â­ è®¾ç½®æ—¶åŒºä¸ºä¸Šæµ·æ—¶é—´ï¼ˆé¿å…æ—¥å¿—æ—¶é—´é”™ä¹±ï¼‰
RUN ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && \
    echo "Asia/Shanghai" > /etc/timezone

# â­ å¯åŠ¨åº”ç”¨ï¼ˆä½¿ç”¨æ•°ç»„å½¢å¼é¿å…shellè§£æé—®é¢˜ï¼‰
CMD ["java", "-jar", "/app/application.jar"]
```

**ä»£ç è¯´æ˜**ï¼š

1. **åŸºç¡€é•œåƒé€‰æ‹©**ï¼š
   ```dockerfile
   FROM openjdk:17-oracle
   ```
   ä½¿ç”¨å®˜æ–¹JDK 17é•œåƒï¼Œç¨³å®šå¯é ã€‚

2. **æ—¶åŒºè®¾ç½®**ï¼š
   ```dockerfile
   RUN ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
   ```
   ç¡®ä¿å®¹å™¨å†…æ—¶é—´ä¸æœ¬åœ°ä¸€è‡´ï¼Œé¿å…æ—¥å¿—æ—¶é—´é”™ä¹±ã€‚

3. **CMDæ ¼å¼**ï¼š
   ```dockerfile
   CMD ["java", "-jar", "/app/application.jar"]
   ```
   ä½¿ç”¨æ•°ç»„æ ¼å¼æ¯”å­—ç¬¦ä¸²æ ¼å¼æ›´å®‰å…¨ï¼Œé¿å…shellè§£æé—®é¢˜ã€‚

### 1.3 ä¼˜åŒ–Dockerfileï¼ˆç”Ÿäº§çº§ï¼‰

```dockerfile
# æ¥è‡ªï¼šç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ
# â­ å¤šé˜¶æ®µæ„å»ºï¼šå‡å°é•œåƒä½“ç§¯
FROM maven:3.9-openjdk-17 AS builder
WORKDIR /build
COPY pom.xml .
COPY src ./src
RUN mvn clean package -DskipTests

# â­ è¿è¡Œæ—¶é•œåƒ
FROM openjdk:17-jre-slim
WORKDIR /app

# â­ åˆ›å»ºérootç”¨æˆ·ï¼ˆå®‰å…¨æœ€ä½³å®è·µï¼‰
RUN addgroup --system --gid 1001 appuser && \
    adduser --system --uid 1001 --gid 1001 appuser

# å¤åˆ¶JARåŒ…
COPY --from=builder /build/target/*.jar /app/application.jar

# è®¾ç½®æ—¶åŒº
RUN ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime

# â­ åˆ‡æ¢åˆ°érootç”¨æˆ·
USER appuser

# â­ JVMå‚æ•°ä¼˜åŒ–
ENV JAVA_OPTS="-Xms512m -Xmx2g -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/app/logs"

EXPOSE 8081

CMD ["sh", "-c", "java $JAVA_OPTS -jar /app/application.jar"]
```

**ä¼˜åŒ–ç‚¹è§£æ**ï¼š

1. **å¤šé˜¶æ®µæ„å»º**ï¼š
   - ç¬¬ä¸€é˜¶æ®µï¼šä½¿ç”¨Mavené•œåƒç¼–è¯‘
   - ç¬¬äºŒé˜¶æ®µï¼šä½¿ç”¨JRE-slimé•œåƒè¿è¡Œ
   - ç»“æœï¼šé•œåƒä½“ç§¯ä»800MBå‡å°‘åˆ°300MB

2. **å®‰å…¨æ€§**ï¼š
   - ä½¿ç”¨érootç”¨æˆ·è¿è¡Œåº”ç”¨
   - ä½¿ç”¨JREè€ŒéJDKï¼ˆå‡å°‘æ”»å‡»é¢ï¼‰

3. **JVMä¼˜åŒ–**ï¼š
   ```
   -Xms512m -Xmx2gï¼šåˆå§‹å’Œæœ€å¤§å †å†…å­˜
   -XX:+UseG1GCï¼šä½¿ç”¨G1åƒåœ¾å›æ”¶å™¨
   -XX:MaxGCPauseMillis=200ï¼šæœ€å¤§GCæš‚åœ200ms
   -XX:+HeapDumpOnOutOfMemoryErrorï¼šOOMæ—¶è‡ªåŠ¨dump
   ```

### 1.4 æ„å»ºé•œåƒ

```bash
# æ¥è‡ªï¼šhttps://github.com/Mark7766/spring-ai-apps/blob/main/newston/docker_image_build.sh
#!/bin/bash

# â­ æ¸…ç†å¹¶æ‰“åŒ…
mvn clean package -DskipTests

# â­ æ„å»ºDockeré•œåƒ
docker build -t newston:latest .

# â­ æ‰“æ ‡ç­¾ï¼ˆç‰ˆæœ¬ç®¡ç†ï¼‰
VERSION=$(date +%Y%m%d%H%M%S)
docker tag newston:latest newston:$VERSION

echo "âœ… Dockeré•œåƒæ„å»ºæˆåŠŸï¼"
echo "ğŸ“¦ é•œåƒæ ‡ç­¾ï¼š"
echo "   - newston:latest"
echo "   - newston:$VERSION"
```

**è„šæœ¬è¯´æ˜**ï¼š
- è‡ªåŠ¨ç”Ÿæˆç‰ˆæœ¬å·ï¼ˆæ—¶é—´æˆ³ï¼‰
- åŒæ—¶åˆ›å»ºlatestå’Œç‰ˆæœ¬å·ä¸¤ä¸ªæ ‡ç­¾
- ä¾¿äºå›æ»šå’Œç‰ˆæœ¬ç®¡ç†

### 1.5 è¿è¡Œå®¹å™¨

```bash
# æ¥è‡ªï¼šhttps://github.com/Mark7766/spring-ai-apps/blob/main/newston/docker_container_start.sh
#!/bin/bash

# â­ åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨
docker stop newston 2>/dev/null || true
docker rm newston 2>/dev/null || true

# â­ å¯åŠ¨æ–°å®¹å™¨
docker run -d \
  -p 8081:8081 \
  --env-file .env \
  --name newston \
  --restart unless-stopped \
  --memory="2g" \
  --cpus="2" \
  --log-driver json-file \
  --log-opt max-size=10m \
  --log-opt max-file=3 \
  newston:latest

echo "âœ… å®¹å™¨å¯åŠ¨æˆåŠŸï¼"
docker ps | grep newston
```

**å‚æ•°è¯´æ˜**ï¼š

| å‚æ•° | è¯´æ˜ | ä½œç”¨ |
|------|------|------|
| `-d` | åå°è¿è¡Œ | é¿å…é˜»å¡ç»ˆç«¯ |
| `-p 8081:8081` | ç«¯å£æ˜ å°„ | å®¿ä¸»æœº8081æ˜ å°„åˆ°å®¹å™¨8081 |
| `--env-file .env` | ç¯å¢ƒå˜é‡æ–‡ä»¶ | æ•æ„Ÿé…ç½®ä¸å†™æ­» |
| `--restart unless-stopped` | è‡ªåŠ¨é‡å¯ | å®¹å™¨å´©æºƒè‡ªåŠ¨é‡å¯ |
| `--memory="2g"` | å†…å­˜é™åˆ¶ | é˜²æ­¢OOMå½±å“å®¿ä¸»æœº |
| `--cpus="2"` | CPUé™åˆ¶ | é™åˆ¶èµ„æºä½¿ç”¨ |
| `--log-opt max-size=10m` | æ—¥å¿—å¤§å°é™åˆ¶ | é˜²æ­¢æ—¥å¿—å æ»¡ç£ç›˜ |

---

## 2. Kuberneteså®Œæ•´éƒ¨ç½²æ–¹æ¡ˆ

### 2.1 ä¸ºä»€ä¹ˆéœ€è¦Kubernetesï¼Ÿ

**å•å®¹å™¨ vs Kubernetes**ï¼š

```
å•æœºDockerï¼š
- æ‰‹åŠ¨å¯åŠ¨å®¹å™¨
- æ‰‹åŠ¨ç›‘æ§å¥åº·
- æ‰‹åŠ¨æ‰©å®¹
- å•ç‚¹æ•…éšœ

Kubernetesï¼š
- è‡ªåŠ¨è°ƒåº¦
- è‡ªåŠ¨é‡å¯
- è‡ªåŠ¨æ‰©ç¼©å®¹
- é«˜å¯ç”¨
```

### 2.2 Deploymenté…ç½®

åˆ›å»º `k8s/deployment.yaml`ï¼š

```yaml
# æ¥è‡ªï¼šç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ
apiVersion: apps/v1
kind: Deployment
metadata:
  name: newston
  labels:
    app: newston
spec:
  # â­ å‰¯æœ¬æ•°é‡
  replicas: 3
  
  # â­ æ»šåŠ¨æ›´æ–°ç­–ç•¥
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1        # æ›´æ–°æ—¶æœ€å¤šå¤š1ä¸ªPod
      maxUnavailable: 0  # æ›´æ–°æ—¶ä¸å…è®¸Podä¸å¯ç”¨
  
  selector:
    matchLabels:
      app: newston
  
  template:
    metadata:
      labels:
        app: newston
    spec:
      containers:
      - name: newston
        image: newston:latest
        ports:
        - containerPort: 8081
        
        # â­ èµ„æºé™åˆ¶
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "2000m"
        
        # â­ ç¯å¢ƒå˜é‡
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "prod"
        - name: SPRING_AI_OPENAI_API_KEY
          valueFrom:
            secretKeyRef:
              name: ai-secrets
              key: api-key
        
        # â­ å¥åº·æ£€æŸ¥
        livenessProbe:
          httpGet:
            path: /actuator/health
            port: 8081
          initialDelaySeconds: 60
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        
        readinessProbe:
          httpGet:
            path: /actuator/health
            port: 8081
          initialDelaySeconds: 30
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
```

**é…ç½®è¯´æ˜**ï¼š

1. **æ»šåŠ¨æ›´æ–°ç­–ç•¥**ï¼š
   ```yaml
   maxSurge: 1
   maxUnavailable: 0
   ```
   - æ›´æ–°æ—¶å…ˆå¯åŠ¨1ä¸ªæ–°Pod
   - æ–°Podå°±ç»ªåï¼Œå†åœæ­¢æ—§Pod
   - ä¿è¯é›¶åœæœºæ›´æ–°

2. **èµ„æºé…ç½®**ï¼š
   ```yaml
   requests: é¢„ç•™èµ„æºï¼ˆè°ƒåº¦ä¾æ®ï¼‰
   limits: æœ€å¤§èµ„æºï¼ˆè¶…è¿‡ä¼šè¢«killï¼‰
   ```

3. **å¥åº·æ£€æŸ¥**ï¼š
   - `livenessProbe`: å­˜æ´»æ¢é’ˆï¼Œå¤±è´¥ä¼šé‡å¯Pod
   - `readinessProbe`: å°±ç»ªæ¢é’ˆï¼Œå¤±è´¥ä¼šä»Serviceç§»é™¤

### 2.3 Serviceé…ç½®

åˆ›å»º `k8s/service.yaml`ï¼š

```yaml
# æ¥è‡ªï¼šç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ
apiVersion: v1
kind: Service
metadata:
  name: newston-service
spec:
  selector:
    app: newston
  type: LoadBalancer  # æˆ– ClusterIP
  ports:
  - port: 80
    targetPort: 8081
    protocol: TCP
  
  # â­ ä¼šè¯äº²å’Œæ€§ï¼ˆå¯é€‰ï¼‰
  sessionAffinity: ClientIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 3600
```

### 2.4 Secreté…ç½®

åˆ›å»º `k8s/secret.yaml`ï¼š

```yaml
# æ¥è‡ªï¼šç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ
apiVersion: v1
kind: Secret
metadata:
  name: ai-secrets
type: Opaque
data:
  # â­ base64ç¼–ç çš„APIå¯†é’¥
  api-key: <base64-encoded-api-key>
```

**åˆ›å»ºSecret**ï¼š

```bash
# ä»æ–‡ä»¶åˆ›å»º
kubectl create secret generic ai-secrets \
  --from-file=api-key=./secrets/api-key.txt

# ä»å­—é¢å€¼åˆ›å»º
kubectl create secret generic ai-secrets \
  --from-literal=api-key=your-api-key
```

### 2.5 éƒ¨ç½²åˆ°K8s

```bash
# â­ åº”ç”¨é…ç½®
kubectl apply -f k8s/secret.yaml
kubectl apply -f k8s/deployment.yaml
kubectl apply -f k8s/service.yaml

# â­ æŸ¥çœ‹çŠ¶æ€
kubectl get pods
kubectl get services

# â­ æŸ¥çœ‹æ—¥å¿—
kubectl logs -f deployment/newston

# â­ æ‰©å®¹
kubectl scale deployment newston --replicas=5

# â­ æ›´æ–°é•œåƒ
kubectl set image deployment/newston newston=newston:v2
```

---

## 3. CI/CDè‡ªåŠ¨åŒ–æµæ°´çº¿

### 3.1 GitHub Actionsé…ç½®

åˆ›å»º `.github/workflows/deploy.yml`ï¼š

```yaml
# æ¥è‡ªï¼šCI/CDæœ€ä½³å®è·µ
name: Build and Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    # â­ æ£€å‡ºä»£ç 
    - uses: actions/checkout@v3
    
    # â­ è®¾ç½®JDK
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
    
    # â­ Mavenç¼“å­˜
    - name: Cache Maven packages
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
    
    # â­ ç¼–è¯‘æµ‹è¯•
    - name: Build with Maven
      run: mvn clean package -DskipTests
    
    # â­ æ„å»ºDockeré•œåƒ
    - name: Build Docker image
      run: |
        docker build -t newston:${{ github.sha }} .
        docker tag newston:${{ github.sha }} newston:latest
    
    # â­ æ¨é€åˆ°é•œåƒä»“åº“
    - name: Push to Docker Hub
      run: |
        echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
        docker push newston:${{ github.sha }}
        docker push newston:latest
    
    # â­ éƒ¨ç½²åˆ°K8s
    - name: Deploy to Kubernetes
      run: |
        kubectl set image deployment/newston newston=newston:${{ github.sha }}
        kubectl rollout status deployment/newston
```

**æµæ°´çº¿æµç¨‹**ï¼š

```
1. è§¦å‘ï¼šPushåˆ°mainåˆ†æ”¯
    â†“
2. æ£€å‡ºä»£ç 
    â†“
3. Mavenç¼–è¯‘æ‰“åŒ…
    â†“
4. æ„å»ºDockeré•œåƒ
    â†“
5. æ¨é€åˆ°é•œåƒä»“åº“
    â†“
6. éƒ¨ç½²åˆ°K8s
    â†“
7. éªŒè¯éƒ¨ç½²çŠ¶æ€
```

### 3.2 Jenkins Pipeline

åˆ›å»º `Jenkinsfile`ï¼š

```groovy
// æ¥è‡ªï¼šCI/CDæœ€ä½³å®è·µ
pipeline {
    agent any
    
    environment {
        DOCKER_IMAGE = "newston"
        K8S_NAMESPACE = "production"
    }
    
    stages {
        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/Mark7766/spring-ai-apps.git'
            }
        }
        
        stage('Build') {
            steps {
                sh 'mvn clean package -DskipTests'
            }
        }
        
        stage('Test') {
            steps {
                sh 'mvn test'
            }
        }
        
        stage('Docker Build') {
            steps {
                sh """
                    docker build -t ${DOCKER_IMAGE}:${BUILD_NUMBER} .
                    docker tag ${DOCKER_IMAGE}:${BUILD_NUMBER} ${DOCKER_IMAGE}:latest
                """
            }
        }
        
        stage('Deploy to K8s') {
            steps {
                sh """
                    kubectl set image deployment/newston newston=${DOCKER_IMAGE}:${BUILD_NUMBER} -n ${K8S_NAMESPACE}
                    kubectl rollout status deployment/newston -n ${K8S_NAMESPACE}
                """
            }
        }
    }
    
    post {
        success {
            echo 'âœ… éƒ¨ç½²æˆåŠŸï¼'
        }
        failure {
            echo 'âŒ éƒ¨ç½²å¤±è´¥ï¼'
        }
    }
}
```

---

## 4. ç›‘æ§å‘Šè­¦ä½“ç³»æ­å»º

### 4.1 Prometheusç›‘æ§é…ç½®

```yaml
# æ¥è‡ªï¼šç›‘æ§æœ€ä½³å®è·µ
# prometheus.yml
scrape_configs:
  - job_name: 'newston'
    kubernetes_sd_configs:
    - role: pod
    relabel_configs:
    - source_labels: [__meta_kubernetes_pod_label_app]
      regex: newston
      action: keep
    - source_labels: [__meta_kubernetes_pod_ip]
      target_label: __address__
      replacement: ${1}:8081
    metrics_path: '/actuator/prometheus'
```

### 4.2 Grafana Dashboard

**å…³é”®æŒ‡æ ‡**ï¼š

```
ğŸ“Š åº”ç”¨æŒ‡æ ‡ï¼š
- QPSï¼ˆæ¯ç§’è¯·æ±‚æ•°ï¼‰
- å“åº”æ—¶é—´ï¼ˆP50ã€P95ã€P99ï¼‰
- é”™è¯¯ç‡
- å¹¶å‘è¿æ¥æ•°

ğŸ“Š JVMæŒ‡æ ‡ï¼š
- å †å†…å­˜ä½¿ç”¨ç‡
- GCæ¬¡æ•°å’Œæ—¶é—´
- çº¿ç¨‹æ•°

ğŸ“Š ä¸šåŠ¡æŒ‡æ ‡ï¼š
- AIè°ƒç”¨æ¬¡æ•°
- Tokenæ¶ˆè€—
- ç¼“å­˜å‘½ä¸­ç‡
```

### 4.3 å‘Šè­¦è§„åˆ™

```yaml
# æ¥è‡ªï¼šç›‘æ§æœ€ä½³å®è·µ
# alert-rules.yml
groups:
- name: newston
  rules:
  # â­ é«˜é”™è¯¯ç‡å‘Šè­¦
  - alert: HighErrorRate
    expr: rate(http_server_requests_errors_total[5m]) > 0.05
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: "é”™è¯¯ç‡è¿‡é«˜"
      description: "{{ $labels.instance }} é”™è¯¯ç‡è¶…è¿‡5%"
  
  # â­ é«˜å“åº”æ—¶é—´å‘Šè­¦
  - alert: HighLatency
    expr: http_server_requests_seconds_p95 > 2
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "å“åº”æ—¶é—´è¿‡é•¿"
      description: "P95å“åº”æ—¶é—´è¶…è¿‡2ç§’"
  
  # â­ å†…å­˜ä½¿ç”¨ç‡å‘Šè­¦
  - alert: HighMemoryUsage
    expr: jvm_memory_used_bytes / jvm_memory_max_bytes > 0.9
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜"
      description: "å†…å­˜ä½¿ç”¨ç‡è¶…è¿‡90%"
```

---

## 5. ç°åº¦å‘å¸ƒä¸å›æ»š

### 5.1 ç°åº¦å‘å¸ƒç­–ç•¥

**æ–¹å¼1ï¼šé‡‘ä¸é›€å‘å¸ƒï¼ˆCanaryï¼‰**

```yaml
# æ¥è‡ªï¼šç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ
# æ—§ç‰ˆæœ¬ï¼š90%æµé‡
apiVersion: apps/v1
kind: Deployment
metadata:
  name: newston-v1
spec:
  replicas: 9
  # ...

---
# æ–°ç‰ˆæœ¬ï¼š10%æµé‡
apiVersion: apps/v1
kind: Deployment
metadata:
  name: newston-v2
spec:
  replicas: 1
  # ...
```

**æ–¹å¼2ï¼šè“ç»¿éƒ¨ç½²**

```bash
# â­ éƒ¨ç½²ç»¿è‰²ç¯å¢ƒ
kubectl apply -f deployment-green.yaml

# â­ éªŒè¯ç»¿è‰²ç¯å¢ƒ
kubectl get pods -l version=green

# â­ åˆ‡æ¢æµé‡
kubectl patch service newston -p '{"spec":{"selector":{"version":"green"}}}'

# â­ ä¿ç•™è“è‰²ç¯å¢ƒä¸€æ®µæ—¶é—´ï¼Œç¡®è®¤æ— é—®é¢˜ååˆ é™¤
kubectl delete deployment newston-blue
```

### 5.2 å¿«é€Ÿå›æ»š

```bash
# â­ æ–¹å¼1ï¼šå›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬
kubectl rollout undo deployment/newston

# â­ æ–¹å¼2ï¼šå›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬
kubectl rollout history deployment/newston
kubectl rollout undo deployment/newston --to-revision=3

# â­ æŸ¥çœ‹å›æ»šçŠ¶æ€
kubectl rollout status deployment/newston
```

---

## 6. ç”Ÿäº§ç¯å¢ƒæ•…éšœå¤„ç†

### 6.1 å¸¸è§é—®é¢˜æ’æŸ¥

**é—®é¢˜1ï¼šPodä¸€ç›´é‡å¯**

```bash
# æŸ¥çœ‹PodçŠ¶æ€
kubectl describe pod <pod-name>

# æŸ¥çœ‹æ—¥å¿—
kubectl logs <pod-name> --previous

# å¸¸è§åŸå› ï¼š
# - å¥åº·æ£€æŸ¥å¤±è´¥
# - OOMï¼ˆå†…å­˜æº¢å‡ºï¼‰
# - åº”ç”¨å¯åŠ¨å¤±è´¥
```

**é—®é¢˜2ï¼šæœåŠ¡æ— æ³•è®¿é—®**

```bash
# æ£€æŸ¥Service
kubectl get svc newston-service

# æ£€æŸ¥ç«¯ç‚¹
kubectl get endpoints newston-service

# æ£€æŸ¥Pod
kubectl get pods -l app=newston

# å¸¸è§åŸå› ï¼š
# - Service selectoré”™è¯¯
# - Podæœªå°±ç»ª
# - ç½‘ç»œç­–ç•¥é™åˆ¶
```

### 6.2 åº”æ€¥é¢„æ¡ˆ

**æ­¥éª¤1ï¼šæ­¢æŸ**

```bash
# å¿«é€Ÿå›æ»š
kubectl rollout undo deployment/newston

# æˆ–ç›´æ¥ç¼©å®¹
kubectl scale deployment newston --replicas=0
```

**æ­¥éª¤2ï¼šå®šä½é—®é¢˜**

```bash
# æŸ¥çœ‹äº‹ä»¶
kubectl get events --sort-by=.metadata.creationTimestamp

# æŸ¥çœ‹æ—¥å¿—
kubectl logs -f deployment/newston --tail=100

# è¿›å…¥å®¹å™¨æ’æŸ¥
kubectl exec -it <pod-name> -- /bin/bash
```

**æ­¥éª¤3ï¼šä¿®å¤ä¸Šçº¿**

```bash
# ä¿®å¤ä»£ç åé‡æ–°éƒ¨ç½²
kubectl apply -f deployment.yaml

# é€æ­¥æ”¾é‡
kubectl scale deployment newston --replicas=1
# è§‚å¯Ÿç¨³å®šåç»§ç»­æ‰©å®¹
kubectl scale deployment newston --replicas=3
```

---

## ğŸ’» ç¤ºä¾‹ä»£ç 

å®Œæ•´é¡¹ç›®ä»£ç ï¼š
- **Newton**: [https://github.com/Mark7766/spring-ai-apps/tree/main/newston](https://github.com/Mark7766/spring-ai-apps/tree/main/newston)
- **Text-to-SQL**: [https://github.com/Mark7766/spring-ai-apps/tree/main/text-to-sql](https://github.com/Mark7766/spring-ai-apps/tree/main/text-to-sql)

**éƒ¨ç½²ç›¸å…³æ–‡ä»¶**ï¼š
```
newston/
â”œâ”€â”€ Dockerfile                    # Dockeré•œåƒå®šä¹‰
â”œâ”€â”€ docker_image_build.sh         # é•œåƒæ„å»ºè„šæœ¬
â”œâ”€â”€ docker_container_start.sh     # å®¹å™¨å¯åŠ¨è„šæœ¬
â”œâ”€â”€ .env.example                  # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â””â”€â”€ k8s/                          # K8sé…ç½®
    â”œâ”€â”€ deployment.yaml
    â”œâ”€â”€ service.yaml
    â””â”€â”€ secret.yaml
```

---

## ğŸ¤” æ€è€ƒé¢˜

1. **å¦‚ä½•è®¾è®¡æ»šåŠ¨æ›´æ–°ç­–ç•¥ä¿è¯é›¶åœæœºï¼Ÿ**
   
   æç¤ºï¼šè€ƒè™‘å¥åº·æ£€æŸ¥ã€ä¼˜é›…å…³é—­ã€æµé‡åˆ‡æ¢ç­‰ã€‚

2. **AIåº”ç”¨çš„ç›‘æ§æŒ‡æ ‡åº”è¯¥å…³æ³¨å“ªäº›ç»´åº¦ï¼Ÿ**
   
   æç¤ºï¼šåº”ç”¨æŒ‡æ ‡ã€JVMæŒ‡æ ‡ã€ä¸šåŠ¡æŒ‡æ ‡ã€æˆæœ¬æŒ‡æ ‡ã€‚

3. **å¦‚ä½•å®ç°å¤šç¯å¢ƒï¼ˆå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ï¼‰çš„é…ç½®ç®¡ç†ï¼Ÿ**
   
   æç¤ºï¼šConfigMapã€Secretã€Helmã€ç¯å¢ƒå˜é‡ç­‰æ–¹æ¡ˆã€‚

---

## ğŸ“– æ‹“å±•é˜…è¯»

- [Kuberneteså®˜æ–¹æ–‡æ¡£](https://kubernetes.io/docs/)
- [Dockeræœ€ä½³å®è·µ](https://docs.docker.com/develop/dev-best-practices/)
- [CI/CDè®¾è®¡æ¨¡å¼](https://www.devops-research.com/research.html)
- [Prometheusç›‘æ§æŒ‡å—](https://prometheus.io/docs/practices/)

---

## â­ï¸ ä¸‹æœŸé¢„å‘Š

æ­å–œä½ æŒæ¡äº†ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ï¼ğŸ‰

**å®æˆ˜ç¯‡åˆ°æ­¤ç»“æŸï¼** ä¸‹ä¸€æœŸæ˜¯æ•´ä¸ªç³»åˆ—çš„æœ€åä¸€æœŸï¼Œæˆ‘ä»¬å°†**æ€»ç»“Spring AIå®Œæ•´çŸ¥è¯†å›¾è°±**ï¼Œå¹¶å±•æœ›AIåº”ç”¨çš„æœªæ¥æ–¹å‘ï¼

**æœ€ç»ˆæœŸäº®ç‚¹**ï¼š
- ğŸ“š å®Œæ•´çŸ¥è¯†ä½“ç³»æ€»ç»“
- ğŸ—ºï¸ Spring AIæŠ€èƒ½å›¾è°±
- ğŸ”® AIåº”ç”¨æœªæ¥è¶‹åŠ¿
- ğŸ’¡ å­¦ä¹ è·¯å¾„å»ºè®®
- ğŸš€ è¿›é˜¶æ–¹å‘æŒ‡å¼•

ä»é›¶åŸºç¡€åˆ°ç”Ÿäº§éƒ¨ç½²ï¼Œæˆ‘ä»¬å·²ç»èµ°è¿‡äº†å®Œæ•´çš„Spring AIå­¦ä¹ ä¹‹æ—…ã€‚ä¸‹ä¸€æœŸï¼Œè®©æˆ‘ä»¬ä¸€èµ·å›é¡¾è¿™æ®µæ—…ç¨‹ï¼Œå±•æœ›æ›´å¹¿é˜”çš„æœªæ¥ï¼

æ•¬è¯·æœŸå¾…ï¼

---

**æ›´æ–°æ—¥æœŸ**ï¼š2025å¹´12æœˆ3æ—¥  
**çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ

